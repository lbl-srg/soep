

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>5. Software Architecture &#8212; Spawn of EnergyPlus</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css" />
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap_custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="_static/bootstrap_custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom-sphinx.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="_static/lbl-icon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="6. Numerical Methods of the Master Algorithm" href="numericalMethods.html" />
    <link rel="prev" title="4. Requirements" href="requirements.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.12.4.min.js "></script>
<script type="text/javascript" src="_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="_static/bootstrap-3.4.1/js/bootstrap.min.js "></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default ">
    <div class="container-fluid">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html"><img src="_static/spawn_icon_darkbluetxhighres.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="index.html">Index</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preample.html">1. Preample</a><ul>
<li class="toctree-l2"><a class="reference internal" href="preample.html#purpose-of-the-document">1.1. Purpose of the Document</a></li>
<li class="toctree-l2"><a class="reference internal" href="preample.html#contributors">1.2. Contributors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="download.html">2. Download</a><ul>
<li class="toctree-l2"><a class="reference internal" href="download.html#software">2.1. Software</a></li>
<li class="toctree-l2"><a class="reference internal" href="download.html#publications">2.2. Publications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">3. Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">4. Requirements</a><ul>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#openstudio-integration">4.1. OpenStudio integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#mathematics">4.2. Mathematics</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#fmu-requirements">4.3. FMU Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#qss-implementation">4.4. QSS Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#master-algorithm">4.5. Master Algorithm</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">5. Software Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overall-software-architecture">5.1. Overall software architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#coupling-of-energyplus-with-modelica">5.2. Coupling of EnergyPlus with Modelica</a></li>
<li class="toctree-l2"><a class="reference internal" href="#distribution-of-spawn-and-the-modelica-buildings-library">5.3. Distribution of Spawn and the Modelica Buildings Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="#integration-of-qss-solver-with-optimica">5.4. Integration of QSS solver with OPTIMICA</a></li>
<li class="toctree-l2"><a class="reference internal" href="#integration-with-openstudio">5.5. Integration with OpenStudio</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="numericalMethods.html">6. Numerical Methods of the Master Algorithm</a><ul>
<li class="toctree-l2"><a class="reference internal" href="numericalMethods.html#time-integration">6.1. Time Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="numericalMethods.html#algebraic-loops">6.2. Algebraic Loops</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="benchmarks.html">7. Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgments.html">8. Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="zreferences.html">10. References</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">5. Software Architecture</a><ul>
<li><a class="reference internal" href="#overall-software-architecture">5.1. Overall software architecture</a></li>
<li><a class="reference internal" href="#coupling-of-energyplus-with-modelica">5.2. Coupling of EnergyPlus with Modelica</a><ul>
<li><a class="reference internal" href="#assumptions-and-limitations">5.2.1. Assumptions and limitations</a></li>
<li><a class="reference internal" href="#sizing-calculations">5.2.2. Sizing calculations</a><ul>
<li><a class="reference internal" href="#sizing-specifications">5.2.2.1. Sizing specifications</a></li>
<li><a class="reference internal" href="#zone-multipliers">5.2.2.2. Zone multipliers</a></li>
<li><a class="reference internal" href="#sizing-parameters-obtained-by-modelica">5.2.2.3. Sizing parameters obtained by Modelica</a></li>
</ul>
</li>
<li><a class="reference internal" href="#unit-system">5.2.3. Unit system</a></li>
<li><a class="reference internal" href="#partitioning-of-the-models">5.2.4. Partitioning of the models</a><ul>
<li><a class="reference internal" href="#coupling-of-the-envelope-model">5.2.4.1. Coupling of the envelope model</a></li>
<li><a class="reference internal" href="#coupling-of-an-opaque-construction">5.2.4.2. Coupling of an opaque construction</a></li>
<li><a class="reference internal" href="#coupling-of-a-zone-surface">5.2.4.3. Coupling of a zone surface</a></li>
<li><a class="reference internal" href="#retrieving-output-variables-from-energyplus">5.2.4.4. Retrieving output variables from EnergyPlus</a></li>
<li><a class="reference internal" href="#sending-input-to-energyplus">5.2.4.5. Sending input to EnergyPlus</a><ul>
<li><a class="reference internal" href="#schedules">5.2.4.5.1. Schedules</a></li>
<li><a class="reference internal" href="#actuators">5.2.4.5.2. Actuators</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#api-used-to-export-energyplus-as-an-fmu">5.2.5. API used to Export EnergyPlus as an FMU</a><ul>
<li><a class="reference internal" href="#instantiation">5.2.5.1. Instantiation</a><ul>
<li><a class="reference internal" href="#envelope-model">5.2.5.1.1. Envelope model</a></li>
<li><a class="reference internal" href="#hvac-zones-used-for-auto-sizing">5.2.5.1.2. HVAC zones used for auto-sizing</a></li>
<li><a class="reference internal" href="#opaque-construction">5.2.5.1.3. Opaque construction</a></li>
<li><a class="reference internal" href="#zone-surface">5.2.5.1.4. Zone surface</a></li>
<li><a class="reference internal" href="#output-variables">5.2.5.1.5. Output variables</a></li>
<li><a class="reference internal" href="#id2">5.2.5.1.6. Schedules</a></li>
<li><a class="reference internal" href="#ems-actuators">5.2.5.1.7. EMS actuators</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#time-synchronization">5.2.6. Time synchronization</a></li>
</ul>
</li>
<li><a class="reference internal" href="#distribution-of-spawn-and-the-modelica-buildings-library">5.3. Distribution of Spawn and the Modelica Buildings Library</a></li>
<li><a class="reference internal" href="#integration-of-qss-solver-with-optimica">5.4. Integration of QSS solver with OPTIMICA</a><ul>
<li><a class="reference internal" href="#fmi-changes-for-qss">5.4.1. FMI Changes for QSS</a><ul>
<li><a class="reference internal" href="#setting-individual-elements-of-the-state-vector">5.4.1.1. Setting individual elements of the state vector</a></li>
<li><a class="reference internal" href="#getting-derivatives-of-state-variables">5.4.1.2. Getting derivatives of state variables</a></li>
<li><a class="reference internal" href="#event-handling">5.4.1.3. Event Handling</a><ul>
<li><a class="reference internal" href="#state-events">5.4.1.3.1. State Events</a></li>
</ul>
</li>
<li><a class="reference internal" href="#getting-derivatives-of-event-indicator-functions">5.4.1.4. Getting derivatives of event indicator functions</a></li>
<li><a class="reference internal" href="#test-models">5.4.1.5. Test models</a><ul>
<li><a class="reference internal" href="#model-with-two-conditions-that-fire-an-event">5.4.1.5.1. Model with two conditions that fire an event</a></li>
<li><a class="reference internal" href="#event-indicators-that-depend-on-the-input">5.4.1.5.2. Event indicators that depend on the input</a></li>
<li><a class="reference internal" href="#handling-of-variables-reinitialized-with-reinit">5.4.1.5.3. Handling of variables reinitialized with <code class="docutils literal notranslate"><span class="pre">reinit()</span></code></a></li>
<li><a class="reference internal" href="#time-events">5.4.1.5.4. Time Events</a></li>
</ul>
</li>
<li><a class="reference internal" href="#smoothtoken-for-qss">5.4.1.6. SmoothToken for QSS</a></li>
<li><a class="reference internal" href="#summary-of-proposed-changes">5.4.1.7. Summary of Proposed Changes</a></li>
<li><a class="reference internal" href="#open-topics">5.4.1.8. Open Topics</a><ul>
<li><a class="reference internal" href="#atomic-api">5.4.1.8.1. Atomic API</a></li>
<li><a class="reference internal" href="#xml-api">5.4.1.8.2. XML/API</a></li>
<li><a class="reference internal" href="#higher-derivatives">5.4.1.8.3. Higher Derivatives</a></li>
<li><a class="reference internal" href="#input-variables">5.4.1.8.4. Input Variables</a></li>
<li><a class="reference internal" href="#annotations">5.4.1.8.5. Annotations</a></li>
<li><a class="reference internal" href="#conditional-expressions-and-event-indicators">5.4.1.8.6. Conditional Expressions and Event Indicators</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#integration-with-openstudio">5.5. Integration with OpenStudio</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="requirements.html" title="Previous Chapter: 4. Requirements"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 4. Requirements</span>
    </a>
  </li>
  <li>
    <a href="numericalMethods.html" title="Next Chapter: 6. Numerical Methods of the Master Algorithm"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">6. Numerical ... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

<!--
          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
-->
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <section id="software-architecture">
<span id="sec-soft-arch"></span><h1><span class="section-number">5. </span>Software Architecture<a class="headerlink" href="#software-architecture" title="Permalink to this headline">¶</a></h1>
<p>This section describes the overall software architecture (<a class="reference internal" href="#sec-ove-sof-arc"><span class="std std-numref">Section 5.1</span></a>),
the coupling of Modelica with EnergyPlus (<a class="reference internal" href="#sec-cou-ene-mod"><span class="std std-numref">Section 5.2</span></a>),
the integration of the QSS solver with OPTIMICA (<a class="reference internal" href="#sec-qss-jmo-int"><span class="std std-numref">Section 5.4</span></a>), and
the OpenStudio integration (<a class="reference internal" href="#sec-int-ope-stu"><span class="std std-numref">Section 5.5</span></a>).</p>
<section id="overall-software-architecture">
<span id="sec-ove-sof-arc"></span><h2><span class="section-number">5.1. </span>Overall software architecture<a class="headerlink" href="#overall-software-architecture" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="#fig-overall-software-architecture"><span class="std std-numref">Fig. 5.1</span></a>
shows the overall software architecture of SOEP.</p>
<p>The <cite>Application</cite> on top of the figure may be an
equipment sales tool that uses an open, or a proprietary,
Modelica model library of their product line, which allows
a sales person to test and size equipment for a particular customer.</p>
<p>The <cite>HVAC Systems Editor</cite> allows drag and drop of components,
which are read dynamically from the <cite>Modelica Library AST</cite>,
similar to what can be done in today’s OS schematic editor.
In contrast, the <cite>Schematic Editor</cite> allows to freely place
and graphically connect Modelica components.
Once models have been manipulated in the
<cite>Schematic Editor</cite>, OS can only simulate them, but not apply
OS Measures to it, as models may have become incompatible
with the OS Measures. (This could in the future be changed
by parsing the AST of the model.)</p>
<p>In the <cite>Schematic Editor</cite>, user-provided Modelica libraries
can be loaded (for example, if a company has their own
control sequence library), manipulated and stored again
in the user-provided Modelica library. This functionality is also
needed for the OpenBuildingControl project.</p>
<p>Currently, the OpenStudio Model Library is compiled C++ code.
Our integration will generate a representation of the
Modelica library that allows OpenStudio to
dynamic load models for the SOEP mode.</p>
<figure class="align-default" id="id4">
<span id="fig-overall-software-architecture"></span><p class="plantuml">
<object data="_images/plantuml-9138fd5933710fb758be340477c667bfb577b0a0.svg" type="image/svg+xml" style="width:1035px;height:720px;">
<img src="_images/plantuml-9138fd5933710fb758be340477c667bfb577b0a0.png" alt="scale max 1024 width

skinparam componentStyle uml2

package OpenStudio {
interface API
API - [Core]

package Legacy-Mode {
database &quot;Legacy\nModel Library&quot;
[Core] -down-&gt; [Legacy\nModel Library]: integrates
[Core] -down-&gt; [HVAC Systems Editor\n(Legacy Mode)]: integrates
[Core] -down-&gt; [EnergyPlus\nSimulator Interface]: integrates
}

package SOEP-Mode {
[Core] -down-&gt; [Model Library]: integrates
[Core] -down-&gt; [HVAC Systems Editor\n(SOEP Mode)]: integrates
[Core] -down-&gt; [SOEP\nSimulator Interface]: integrates
}
}

package SOEP {
database &quot;Modelica\nLibrary AST&quot; as mod_AST
database &quot;Modelica\nBuildings Library&quot;

[Model Library] --&gt; mod_AST : parses json\nAST

[HVAC Systems Editor\n(SOEP Mode)] ..&gt; mod_AST : parses json\nAST

[Conversion Script] .&gt; [OPTIMICA]: parses\nAST
[SOEP\nSimulator Interface] .&gt; [OPTIMICA] : writes inputs,\nruns simulation,\nreads outputs

[Conversion Script] -&gt; mod_AST: generates
[OPTIMICA] -&gt; [Modelica\nBuildings Library]: imports
}


actor Developer as epdev
[Legacy\nModel Library] &lt;.left. epdev : updates

actor &quot;Developer or User&quot; as modev
[Conversion Script] &lt;.. modev : invokes

actor Developer as budev
[Modelica\nBuildings Library] &lt;.. budev : adds annotations

[Application] ..&gt; () API : uses
[Measures] ..&gt; () API : uses

database &quot;User-Provided\nModelica Library&quot;
[OPTIMICA] --&gt; [User-Provided\nModelica Library]: imports

EnergyPlus &lt;.left. [EnergyPlus\nSimulator Interface]: writes inputs,\nruns simulation,\nreads outputs

package EnergyPlus {
  [EnergyPlus.exe]
}

actor User as mouse
[User-Provided\nModelica Library] &lt;.. mouse : adds annotations

note left of mod_AST
  Used as an intermediate format and
  to verify incompatible changes.
end note

note bottom of [User-Provided\nModelica Library]
  Allows companies to use
  their own Modelica libraries
  with custom HVAC systems and
  control sequences, or
  to integrate an electronic
  equipment catalog or a
  library used for an equipment
  sales tool.
end note

note right of Application
  Application that uses
  the OpenStudio SDK.
end note"/>

</object></p>
<figcaption>
<p><span class="caption-number">Fig. 5.1 </span>: Overall software architecture.</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="coupling-of-energyplus-with-modelica">
<span id="sec-cou-ene-mod"></span><h2><span class="section-number">5.2. </span>Coupling of EnergyPlus with Modelica<a class="headerlink" href="#coupling-of-energyplus-with-modelica" title="Permalink to this headline">¶</a></h2>
<p>This section describes the coupling of EnergyPlus with Modelica.
The coupling allows two types of interactions between the two tools:</p>
<ol class="arabic simple">
<li><p>The EnergyPlus envelope model can be coupled with the Modelica room model,
which in turn is coupled to Modelica HVAC and interzone air exchange.
This is described in <a class="reference internal" href="#sec-cou-env"><span class="std std-numref">Section 5.2.4.1</span></a>.</p></li>
<li><p>Modelica can instantiate and then read EnergyPlus output variables.
This is described in <a class="reference internal" href="#sec-out-var"><span class="std std-numref">Section 5.2.4.4</span></a>.</p></li>
<li><p>Modelica can instantiate and then set the values of EnergyPlus schedules and EMS actuators.
This is described in <a class="reference internal" href="#sec-sen-var"><span class="std std-numref">Section 5.2.4.5</span></a>.</p></li>
</ol>
<p>Users will set up this data exchange by instantiating corresponding
Modelica models or blocks. These Modelica instances will then
communicate with EnergyPlus, using Modelica C functions,
to package EnergyPlus as an FMU for Model Exchange 2.0.
Modelica will then automatically instantiate this FMU and use it
for the simulation using the FMI Library from Modelon.</p>
<section id="assumptions-and-limitations">
<h3><span class="section-number">5.2.1. </span>Assumptions and limitations<a class="headerlink" href="#assumptions-and-limitations" title="Permalink to this headline">¶</a></h3>
<p>To implement the coupling, will make the following assumptions:</p>
<ol class="arabic">
<li><p>Only the lumped room air model will be refactored, not the
room model with stratified room air.
The reason is to keep focus and make progress before increasing complexity.</p></li>
<li><p>The HVAC and the pressure driven air exchange (airflow network) are
either in Modelica or EnergyPlus.
The two methods cannot be combined.
The reason is that the legacy EnergyPlus computes in its “predictor/corrector”
the room temperature as follows:</p>
<ol class="loweralpha simple">
<li><p>First it computes the HVAC power required to meet the temperature set point,</p></li>
<li><p>next it simulates the HVAC system to see whether it can meet this load, and</p></li>
<li><p>finally it updates the room temperature using the HVAC power from step (b).</p></li>
</ol>
<p>This is fundamentally different from the ODE solver used by SOEP who sets the new
room temperature and time, computes the time derivative, and then recomputes
the new time step.</p>
</li>
<li><p>In each room, mass, as opposed to volume, is conserved.
The reason is that this does not induce an air flow in the HVAC system if
the room to temperature changes. Hence, it decouples the thermal and the mass balance.</p></li>
</ol>
</section>
<section id="sizing-calculations">
<span id="sec-aut-siz"></span><h3><span class="section-number">5.2.2. </span>Sizing calculations<a class="headerlink" href="#sizing-calculations" title="Permalink to this headline">¶</a></h3>
<p>Spawn allows to invoke the EnergyPlus zone sizing calculations and to retrieve sizing data in
Modelica for each thermal zone and for groups of thermal zones, the latter taking
into account load diversity as needed for system sizing.
The sizing data are sensible and latent cooling loads, heating loads, minimum
outdoor air flow rates, corresponding outdoor conditions needed for sizing
of central air handlers or central cooling and heating plants,
and the times when the sizing conditions occur.</p>
<p>During the EnergyPlus sizing calculations, no time-dependent data of Modelica is used.
Thus, any supply air flow rate, infiltration, interzonal air exchange or
internal loads modeled in Modelica
is not taken into account in the sizing calculation, and users need to add such
contributions to the results obtained by EnergyPlus.
<em>To be discussed:</em> Infiltration, interzonal air exchange and internal loads that are
specified in the EnergyPlus idf file is taken into account in the sizing calculation.</p>
<section id="sizing-specifications">
<h4><span class="section-number">5.2.2.1. </span>Sizing specifications<a class="headerlink" href="#sizing-specifications" title="Permalink to this headline">¶</a></h4>
<p>For the zone sizing calculations, EnergyPlus uses the sizing specified in the idf file.
Thus, idf objects such as
<code class="docutils literal notranslate"><span class="pre">SizingPeriod:DesignDay</span></code>,
<code class="docutils literal notranslate"><span class="pre">Sizing:Parameter</span></code>,
<code class="docutils literal notranslate"><span class="pre">SizingPeriod:WeatherFileDays</span></code> and
<code class="docutils literal notranslate"><span class="pre">SizingPeriod:WeatherFileConditionType</span></code> may be used.
However, whether a sizing is performed is determined by a Modelica parameter.</p>
<p>Spawn removes the HVAC system in the idf file, the idf objects
<code class="docutils literal notranslate"><span class="pre">DesignSpecification:ZoneHVAC:Sizing</span></code>,
<code class="docutils literal notranslate"><span class="pre">DesignSpecification:OutdoorAir</span></code> (<strong>fixme: to be discussed</strong>),
<code class="docutils literal notranslate"><span class="pre">DesignSpecification:OutdoorAir:SpaceList</span></code> (<strong>fixme: to be discussed</strong>),
<code class="docutils literal notranslate"><span class="pre">DesignSpecification:ZoneAirDistribution</span></code>, and
<code class="docutils literal notranslate"><span class="pre">DesignSpecification:AirTerminal:Sizing</span></code>
are not taken into account, and also
any sizing specification in
<code class="docutils literal notranslate"><span class="pre">ZoneAirHeatBalanceAlgorithm</span></code> is disregarded.</p>
<p>EnergyPlus also has sizing specification in the idf object
<code class="docutils literal notranslate"><span class="pre">SimulationControl</span></code>. These settings are ignored as only few of the settings
are applicable, and those that are applicable are exposed as Modelica parameters.</p>
</section>
<section id="zone-multipliers">
<h4><span class="section-number">5.2.2.2. </span>Zone multipliers<a class="headerlink" href="#zone-multipliers" title="Permalink to this headline">¶</a></h4>
<p>Up to the Modelica Buildings Library version 11, the Spawn coupling does not support
zone multipliers. If an idf file contains a <code class="docutils literal notranslate"><span class="pre">Zone</span></code> object with a multiplier that is
not 1, the simulation stops with an error.</p>
<p>In later versions, EnergyPlus multipliers are supported. This allows for example
authoring of the EnergyPlus envelope geometry, including adding multipliers for zones,
in dedicated EnergyPlus envelope authoring tools such as OpenStudio.
Spawn handles multipliers as follows:</p>
<p>If idf file contains in the <code class="docutils literal notranslate"><span class="pre">Zone</span></code> object the entry <code class="docutils literal notranslate"><span class="pre">Multiplier</span></code>,
then EnergyPlus multiplies the zone volume, zone floor area and internal and external loads.
EnergyPlus also takes the multiplier into account in the heat flow rates that are exchanged
between Modelica and EnergyPlus.
Hence, this allows through a specification in the idf file to multiply the size
of thermal zones.
Modelica will then use these multiplied values in its simulation.
For example, suppose an idf file specifies a zone that
has a volume of <span class="math notranslate nohighlight">\(V=100 \, \mathrm{m^3}\)</span>,
a design air flow rate of <span class="math notranslate nohighlight">\(\dot m_0 = 1.0 \, \mathrm{kg/s}\)</span> and
a zone multiplier of <span class="math notranslate nohighlight">\(2\)</span>.
Then, Modelica will obtain a zone volume of <span class="math notranslate nohighlight">\(V=200 \, \mathrm{m^3}\)</span>,
and users need to ensure that the design air mass flow rate
in Modelica is <span class="math notranslate nohighlight">\(\dot m_0 = 2.0 \, \mathrm{kg/s}\)</span>.</p>
<p>EnergyPlus allows a zone to be added to a <code class="docutils literal notranslate"><span class="pre">ZoneList</span></code>, and a <code class="docutils literal notranslate"><span class="pre">ZoneList</span></code> to
be added to a <code class="docutils literal notranslate"><span class="pre">Zone</span> <span class="pre">Group</span></code>.
For example, a <code class="docutils literal notranslate"><span class="pre">ZoneList</span></code> allows all zones
on a floor to be listed, and a <code class="docutils literal notranslate"><span class="pre">Zone</span> <span class="pre">Group</span></code> allows all zones to be multiplied
such as to model a high-rise building.
EnergyPlus takes the <code class="docutils literal notranslate"><span class="pre">Zone</span> <span class="pre">Group</span></code> into account.
Thus, if the zone in the above example has a multiplier of <span class="math notranslate nohighlight">\(2\)</span>,
and it is added to an EnergyPlus <code class="docutils literal notranslate"><span class="pre">Zone</span> <span class="pre">Group</span></code>
which has a multiplier of <span class="math notranslate nohighlight">\(3\)</span>, then EnergyPlus will send its
surface, volume and load after multiplying it by a factor of <span class="math notranslate nohighlight">\(6\)</span>.
Therefore, users need to ensure that the design air mass flow rate
in Modelica is <span class="math notranslate nohighlight">\(\dot m_0 = 6.0 \, \mathrm{kg/s}\)</span>.</p>
<p>In Modelica, thermal zones may be grouped to HVAC systems.
As the HVAC system in the idf file is removed, Modelica has its own object to
group thermal zones to an HVAC system for the purpose of taking into account
the load diversity for system sizing. The corresponding Modelica class is
called <code class="docutils literal notranslate"><span class="pre">HVACZones</span></code>.
Note that the Modelica <code class="docutils literal notranslate"><span class="pre">HVACZones</span></code> model has no entry for zone or group multipliers,
as the values from the idf file are applied during the system sizing
as described in the above two paragraphs.</p>
</section>
<section id="sizing-parameters-obtained-by-modelica">
<h4><span class="section-number">5.2.2.3. </span>Sizing parameters obtained by Modelica<a class="headerlink" href="#sizing-parameters-obtained-by-modelica" title="Permalink to this headline">¶</a></h4>
<p>If Modelica enabled the EnergyPlus sizing calculations,
it will receive for each Modelica <code class="docutils literal notranslate"><span class="pre">ThermalZone</span></code> the
sensible cooling load,
latent cooling load,
and the corresponding outdoor air temperature,
humidity concentration, minimum outdoor air mass flow rate and the time
when these loads occur.
These quantities are assigned by the Spawn interface to Modelica parameters,
and these values already take into account the <code class="docutils literal notranslate"><span class="pre">Multiplier</span></code> of both,
the <code class="docutils literal notranslate"><span class="pre">Zone</span></code> object and the <code class="docutils literal notranslate"><span class="pre">Zone</span> <span class="pre">Group</span></code> object
in the EnergyPlus idf file.
The values can then be used in Modelica parameter expressions to assign
component sizes.</p>
<p>Modelica also allows <code class="docutils literal notranslate"><span class="pre">ThermalZones</span></code> to be grouped together through the Modelica
<code class="docutils literal notranslate"><span class="pre">HVACZones</span></code> object, which
allows for sizing calculations to take into account the load diversity.
For each group, the above quantities will be obtained, also as
Modelica parameters.</p>
</section>
</section>
<section id="unit-system">
<span id="sec-uni-sys"></span><h3><span class="section-number">5.2.3. </span>Unit system<a class="headerlink" href="#unit-system" title="Permalink to this headline">¶</a></h3>
<p>Modelica and EnergyPlus each have their own unit system. Spawn of EnergyPlus will
automatically convert between these units, using information from the <code class="docutils literal notranslate"><span class="pre">modelDescription.xml</span></code> file,
or stop the simulation if an unknown unit is encountered.
The Modelica Buildings Library will do the unit conversion using C functions.
These C functions will convert between the units shown in <a class="reference internal" href="#tab-uni-spe"><span class="std std-numref">Table 5.1</span></a>.
The table also shows unit strings that are allowed to use by EnergyPlus
to tell Modelica the unit of the exchanged inputs and outputs.
The C functions will then convert the quantity as needed to represent
it in the units shown in the column <cite>Modelica Unit</cite>.</p>
<span id="tab-uni-spe"></span><table class="docutils align-default" id="id5">
<caption><span class="caption-number">Table 5.1 </span><span class="caption-text">Unit specification of EnergyPlus I/O.</span><a class="headerlink" href="#id5" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 32%" />
<col style="width: 24%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Quantity</p></th>
<th class="head"><p>EnergyPlus
Unit String</p></th>
<th class="head"><p>Modelica Unit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Angle (rad)</p></td>
<td><p>rad</p></td>
<td><p>rad</p></td>
</tr>
<tr class="row-odd"><td><p>Angle (deg)</p></td>
<td><p>deg</p></td>
<td><p>rad</p></td>
</tr>
<tr class="row-even"><td><p>Energy</p></td>
<td><p>J</p></td>
<td><p>J</p></td>
</tr>
<tr class="row-odd"><td><p>Illuminance</p></td>
<td><p>lux</p></td>
<td><p>lm/m2</p></td>
</tr>
<tr class="row-even"><td><p>Humidity (absolute)</p></td>
<td><p>kgWater/kgDryAir</p></td>
<td><p>1 (converted to mass fraction
per total mass of moist air)</p></td>
</tr>
<tr class="row-odd"><td><p>Humidity (relative)</p></td>
<td><p>%</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>Luminous flux</p></td>
<td><p>lum</p></td>
<td><p>cd.sr</p></td>
</tr>
<tr class="row-odd"><td><p>Mass flow rate</p></td>
<td><p>kg/s</p></td>
<td><p>kg/s</p></td>
</tr>
<tr class="row-even"><td><p>Power</p></td>
<td><p>W</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-odd"><td><p>Pressure</p></td>
<td><p>Pa</p></td>
<td><p>Pa</p></td>
</tr>
<tr class="row-even"><td><p>Status (e.g., rain)</p></td>
<td><p>(no character)</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td><p>Temperature</p></td>
<td><p>degC</p></td>
<td><p>K</p></td>
</tr>
<tr class="row-even"><td><p>Time</p></td>
<td><p>s</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-odd"><td><p>Transmittance,
reflectance, and
absorptance</p></td>
<td><p>(no character,
specified as a
value between 0
and 1)</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-even"><td><p>Volume flow rate</p></td>
<td><p>m3/s</p></td>
<td><p>m3/s</p></td>
</tr>
</tbody>
</table>
</section>
<section id="partitioning-of-the-models">
<h3><span class="section-number">5.2.4. </span>Partitioning of the models<a class="headerlink" href="#partitioning-of-the-models" title="Permalink to this headline">¶</a></h3>
<p>To link EnergyPlus and Modelica, the models are partitioned as shown in
as shown in <a class="reference internal" href="#fig-partition-envelope-room-hvac"><span class="std std-numref">Fig. 5.2</span></a>.
Loosely speaking, everything that is air and controls is simulated in Modelica,
while EnergyPlus simulates heat conduction in solid and through windows.
Both simulators can declare and use schedules, and they can interact through
the thermal zone model, through EnergyPlus outputs and through EnergyPlus
schedules and EMS actuators.</p>
<figure class="align-default" id="id6">
<span id="fig-partition-envelope-room-hvac"></span><a class="reference internal image-reference" href="_images/envelope-room-hvac.svg"><img alt="_images/envelope-room-hvac.svg" src="_images/envelope-room-hvac.svg" width="1600px" /></a>
<figcaption>
<p><span class="caption-number">Fig. 5.2 </span>: Partitioning of the envelope, room and HVAC model.</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The following <a class="reference internal" href="#sec-cou-env"><span class="std std-numref">Section 5.2.4.1</span></a> specifies the coupling of these models,
<a class="reference internal" href="#sec-req-ene-exp-fmu"><span class="std std-numref">Section 5.2.5</span></a> describes the API used to generate the FMU, and
<a class="reference internal" href="#sec-time-sync"><span class="std std-numref">Section 5.2.6</span></a> describes the synchronization of the tools.</p>
<section id="coupling-of-the-envelope-model">
<span id="sec-cou-env"></span><h4><span class="section-number">5.2.4.1. </span>Coupling of the envelope model<a class="headerlink" href="#coupling-of-the-envelope-model" title="Permalink to this headline">¶</a></h4>
<p>To couple the Modelica room model to the EnergyPlus envelope model, EnergyPlus exposes the following parameters.
Modelica will obtain their values during the initialization of the Modelica model.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 71%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Quantity</p></th>
<th class="head"><p>Unit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>V</p></td>
<td><p>Volume of the zone air.</p></td>
<td><p>m3</p></td>
</tr>
<tr class="row-odd"><td><p>AFlo</p></td>
<td><p>Floor area of the zone.</p></td>
<td><p>m2</p></td>
</tr>
<tr class="row-even"><td><p>mSenFac</p></td>
<td><p>Factor for scaling the sensible thermal mass of the zone air volume.</p></td>
<td><p>1</p></td>
</tr>
<tr class="row-odd"><td colspan="3"><p><em>Parameters obtained from EnergyPlus zone HVAC sizing. Note that</em> sizZon <em>is a Modelica record used to group sizing parameter</em>
<em>If sizing is disabled, then these values are set to zero.</em>
<em>All quantities are after applying all EnergyPlus zone and group multipliers.</em></p></td>
</tr>
<tr class="row-even"><td><p>sizZon.QCooSen_flow</p></td>
<td><p>Design sensible cooling load.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-odd"><td><p>sizZon.QCooLat_flow</p></td>
<td><p>Design latent cooling load.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-even"><td><p>sizZon.TOutCoo</p></td>
<td><p>Outdoor drybulb temperature at the cooling design load.</p></td>
<td><p>degC</p></td>
</tr>
<tr class="row-odd"><td><p>sizZon.XOutCoo</p></td>
<td><p>Outdoor humidity ratio at the cooling design load per total air mass of the zone.</p></td>
<td><p>kg/kg</p></td>
</tr>
<tr class="row-even"><td><p>sizZon.tCoo</p></td>
<td><p>Time at which these loads occurred.</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-odd"><td><p>sizZon.QHea_flow</p></td>
<td><p>Design heating load.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-even"><td><p>sizZon.TOutHea</p></td>
<td><p>Outdoor drybulb temperature at the heating design load.</p></td>
<td><p>kg/kg</p></td>
</tr>
<tr class="row-odd"><td><p>sizZon.XOutHea</p></td>
<td><p>Outdoor humidity ratio at the heating design load per total air mass of the zone.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-even"><td><p>sizZon.mOutCoo_flow</p></td>
<td><p>Minimum outdoor air flow rate during the cooling design load.</p></td>
<td><p>kg/s</p></td>
</tr>
<tr class="row-odd"><td><p>sizZon.mOutHea_flow</p></td>
<td><p>Minimum outdoor air flow rate during the heating design load.</p></td>
<td><p>kg/s</p></td>
</tr>
<tr class="row-even"><td><p>sizZon.tHea</p></td>
<td><p>Time at which these loads occurred.</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-odd"><td colspan="3"><p><em>Parameters obtained from EnergyPlus HVAC system sizing, taking into account the load diversity of thermal zones that are part of this HVAC system.</em>
<em>Note that</em> sizSys <em>is a Modelica record used to group sizing parameter.</em>
<em>If sizing is disabled, then these values are set to zero.</em>
<em>All quantities are after applying all EnergyPlus zone and group multipliers.</em></p></td>
</tr>
<tr class="row-even"><td><p>sizSys.QCooSen_flow</p></td>
<td><p>Design sensible cooling load.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-odd"><td><p>sizSys.QCooLat_flow</p></td>
<td><p>Design latent cooling load.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-even"><td><p>sizSys.TOutCoo</p></td>
<td><p>Outdoor drybulb temperature at the cooling design load.</p></td>
<td><p>degC</p></td>
</tr>
<tr class="row-odd"><td><p>sizSys.XOutCoo</p></td>
<td><p>Outdoor humidity ratio at the cooling design load per total air mass of the zone.</p></td>
<td><p>kg/kg</p></td>
</tr>
<tr class="row-even"><td><p>sizSys.tCoo</p></td>
<td><p>Time at which these loads occurred.</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-odd"><td><p>sizSys.QHea_flow</p></td>
<td><p>Design heating load.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-even"><td><p>sizSys.TOutHea</p></td>
<td><p>Outdoor drybulb temperature at the heating design load.</p></td>
<td><p>kg/kg</p></td>
</tr>
<tr class="row-odd"><td><p>sizSys.XOutHea</p></td>
<td><p>Outdoor humidity ratio at the heating design load per total air mass of the zone.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-even"><td><p>sizSys.mOutCoo_flow</p></td>
<td><p>Minimum outdoor air flow rate during the cooling design load.</p></td>
<td><p>kg/s</p></td>
</tr>
<tr class="row-odd"><td><p>sizSys.mOutHea_flow</p></td>
<td><p>Minimum outdoor air flow rate during the heating design load.</p></td>
<td><p>kg/s</p></td>
</tr>
<tr class="row-even"><td><p>sizSys.tHea</p></td>
<td><p>Time at which these loads occurred.</p></td>
<td><p>s</p></td>
</tr>
</tbody>
</table>
<p>The following time-dependent variables are exchanged between EnergyPlus and Modelica during the time integration
for each thermal zone.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 71%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Quantity</p></th>
<th class="head"><p>Unit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td colspan="3"><p><em>From Modelica to EnergyPlus</em></p></td>
</tr>
<tr class="row-odd"><td><p>T</p></td>
<td><p>Temperature of the zone air.</p></td>
<td><p>degC</p></td>
</tr>
<tr class="row-even"><td><p>X</p></td>
<td><p>Water vapor mass fraction per total air mass of the zone.</p></td>
<td><p>kg/kg</p></td>
</tr>
<tr class="row-odd"><td><p>mInlets_flow</p></td>
<td><p>Sum of positive mass flow rates into the zone for all air inlets (including infiltration).</p></td>
<td><p>kg/s</p></td>
</tr>
<tr class="row-even"><td><p>TInlet</p></td>
<td><p>Average of inlets medium temperatures carried by the mass flow rates.</p></td>
<td><p>degC</p></td>
</tr>
<tr class="row-odd"><td><p>QGaiRad_flow</p></td>
<td><p>Radiative sensible heat gain added to the zone.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-even"><td><p>t</p></td>
<td><p>Model time at which the above inputs are valid, with <span class="math notranslate nohighlight">\(t=0\)</span> defined as January 1, 0 am local time,
and with
no correction for daylight savings time.</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-odd"><td colspan="3"><p><em>From EnergyPlus to Modelica</em></p></td>
</tr>
<tr class="row-even"><td><p>TRad</p></td>
<td><p>Average radiative temperature in the room.</p></td>
<td><p>degC</p></td>
</tr>
<tr class="row-odd"><td><p>QConSen_flow</p></td>
<td><p>Convective sensible heat added to the zone, e.g., from surface convection and from
the EnergyPlus’ <code class="docutils literal notranslate"><span class="pre">People</span></code> or <code class="docutils literal notranslate"><span class="pre">Equipment</span></code> schedule.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-even"><td><p>QLat_flow</p></td>
<td><p>Latent heat gain added to the zone, e.g., from mass transfer with moisture buffering material and
from EnergyPlus’ <code class="docutils literal notranslate"><span class="pre">People</span></code> schedule.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-odd"><td><p>QPeo_flow</p></td>
<td><p>Heat gain due to people (only to be used to optionally compute CO2 emitted by people).</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-even"><td><p>nextEventTime</p></td>
<td><p>Model time <span class="math notranslate nohighlight">\(t\)</span> when EnergyPlus needs to be called next (typically the next zone time step).</p></td>
<td><p>s</p></td>
</tr>
</tbody>
</table>
<p>Note that the EnergyPlus object <code class="docutils literal notranslate"><span class="pre">ZoneAirContaminantBalance</span></code> either allows CO2 concentration modeling,
or a generic contaminant modeling (such as from material outgasing),
or no contaminant modeling, or both. To avoid ambiguities regarding what contaminant
is being modeled, we do not receive the contaminant emission from EnergyPlus.
Instead, we obtain the heat gain due to people, which is then used to optionally compute the
CO2 emitted by people.</p>
<p>The calling sequences of the functions that send data to EnergyPlus and read data from EnergyPlus is
as for any <a class="reference internal" href="glossary.html#term-continuous-time-variable"><span class="xref std std-term">continuous-time variable</span></a> in FMI. That is, at any time instant,
variables can be set multiple times, and the values returned by EnergyPlus must be computed
using the current input variables. (For example, multiple calls within a time step are used to compute
the derivative of <code class="docutils literal notranslate"><span class="pre">QConSen_flow</span></code> with respect to <code class="docutils literal notranslate"><span class="pre">T</span></code>.)</p>
</section>
<section id="coupling-of-an-opaque-construction">
<span id="sec-cou-opa-con"></span><h4><span class="section-number">5.2.4.2. </span>Coupling of an opaque construction<a class="headerlink" href="#coupling-of-an-opaque-construction" title="Permalink to this headline">¶</a></h4>
<p>The following interface models the coupling of an heat transfer model for an opaque construction
with the two surfaces of an EnergyPlus <cite>BuildingSurface:Detailed</cite>.
This allows for example coupling of a radiant slab that is modeled in Modelica
to the EnergyPlus thermal zone model. Examples of such radiant systems include a floor slab with embedded
pipes and a radiant cooling panel that is suspended from a ceiling.</p>
<p>The partitioning is such that Modelica models the heat transfer between the surfaces and the device
behind the surface (e.g., a concrete slab with pipes or a radiant panel) and sends
the surface temperatures to EnergyPlus. EnergyPlus
models the heat transfer between the front surface and its respective thermal zone,
and it models the heat transfer of the back surface and its respective boundary condition,
which could be another thermal zone, the outside, or the ground coupling,
depending on its specification of the <cite>Outside Boundary Condition</cite> in EnergyPlus.
Therefore, EnergyPlus will
model all heat that enters the surface from its external boundary condition.
For a thermal zone or the outside, this is the convective heat transfer,
the short-wave radiation absorbed by the surface and the
long-wave radiation absorbed minus emitted by the surface.
For ground coupled surfaces, this is the heat transfer from the ground.</p>
<p>EnergyPlus exposes the following parameter, which Modelica will obtain during the initialization.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 71%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Quantity</p></th>
<th class="head"><p>Unit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A</p></td>
<td><p>Area of the surface that is exposed to the thermal zone.</p></td>
<td><p>m2</p></td>
</tr>
</tbody>
</table>
<p>The following time-dependent variables are exchanged between EnergyPlus and Modelica during the time integratione.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 71%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Quantity</p></th>
<th class="head"><p>Unit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td colspan="3"><p><em>From Modelica to EnergyPlus</em></p></td>
</tr>
<tr class="row-odd"><td><p>TFront</p></td>
<td><p>Temperature of the front-facing surface.</p></td>
<td><p>degC</p></td>
</tr>
<tr class="row-even"><td><p>TBack</p></td>
<td><p>Temperature of the back-facing surface.</p></td>
<td><p>degC</p></td>
</tr>
<tr class="row-odd"><td><p>t</p></td>
<td><p>Model time at which the above inputs T is valid, with <span class="math notranslate nohighlight">\(t=0\)</span> defined as January 1, 0 am local time,
and with
no correction for daylight savings time.</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-even"><td colspan="3"><p><em>From EnergyPlus to Modelica</em></p></td>
</tr>
<tr class="row-odd"><td><p>QFront_flow</p></td>
<td><p>Net heat flow rate from the thermal zone to the front-facing surface,
consisting of convective heat flow,
absorbed solar radiation, absorbed infrared radiation minus emitted infrared radiation.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-even"><td><p>QBack_flow</p></td>
<td><p>Net heat flow rate to the back-facing surface.
If coupled to another thermal zone or the outside, this consist of convective heat flow,
absorbed solar radiation, absorbed infrared radiation minus emitted infrared radiation.
If coupled to the ground, this consists of the heat flow rate from the ground.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-odd"><td><p>nextEventTime</p></td>
<td><p>Model time <span class="math notranslate nohighlight">\(t\)</span> when EnergyPlus needs to be called next (typically the next zone time step).</p></td>
<td><p>s</p></td>
</tr>
</tbody>
</table>
<p>The calling sequences of the functions that send data to EnergyPlus and read data from EnergyPlus is
as for any <a class="reference internal" href="glossary.html#term-continuous-time-variable"><span class="xref std std-term">continuous-time variable</span></a> in FMI. That is, at any time instant,
variables can be set multiple times, and the values returned by EnergyPlus must be computed
using the current input variables. (For example, multiple calls within a time step may be used to compute
the derivative of <code class="docutils literal notranslate"><span class="pre">QFront_flow</span></code> with respect to <code class="docutils literal notranslate"><span class="pre">TFront</span></code>, and <code class="docutils literal notranslate"><span class="pre">QBack_flow</span></code> with respect to <code class="docutils literal notranslate"><span class="pre">TBack</span></code>.)</p>
</section>
<section id="coupling-of-a-zone-surface">
<span id="sec-cou-zon-sur"></span><h4><span class="section-number">5.2.4.3. </span>Coupling of a zone surface<a class="headerlink" href="#coupling-of-a-zone-surface" title="Permalink to this headline">¶</a></h4>
<p>The following interface models the heat transfer of a surface with the EnergyPlus thermal zone.
This allows for example coupling of a radiant heating in the 1st floor that is modeled in Modelica
to the EnergyPlus thermal zone model for heat exchange with the zone,
while simulating the ground coupling of the slab in Modelica. EnergyPlus
models the heat transfer between the surface and the thermal zone. Therefore, EnergyPlus will
model the convective heat transfer, the short-wave radiation absorbed by the surface and the
long-wave radiation absorbed minus emitted by the surface.</p>
<p>EnergyPlus exposes the following parameter, which Modelica will obtain during the initialization.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 71%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Quantity</p></th>
<th class="head"><p>Unit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A</p></td>
<td><p>Area of the surface that is exposed to the thermal zone.</p></td>
<td><p>m2</p></td>
</tr>
</tbody>
</table>
<p>The following time-dependent variables are exchanged between EnergyPlus and Modelica during the time integratione.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 18%" />
<col style="width: 71%" />
<col style="width: 11%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Quantity</p></th>
<th class="head"><p>Unit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td colspan="3"><p><em>From Modelica to EnergyPlus</em></p></td>
</tr>
<tr class="row-odd"><td><p>T</p></td>
<td><p>Temperature of the surface.</p></td>
<td><p>degC</p></td>
</tr>
<tr class="row-even"><td><p>t</p></td>
<td><p>Model time at which the above inputs T is valid, with <span class="math notranslate nohighlight">\(t=0\)</span> defined as January 1, 0 am local time,
and with
no correction for daylight savings time.</p></td>
<td><p>s</p></td>
</tr>
<tr class="row-odd"><td colspan="3"><p><em>From EnergyPlus to Modelica</em></p></td>
</tr>
<tr class="row-even"><td><p>Q_flow</p></td>
<td><p>Net heat flow rate from the thermal zone to the surface, consisting of convective heat flow,
absorbed solar radiation, absorbed infrared radiation minus emitted infrared radiation.</p></td>
<td><p>W</p></td>
</tr>
<tr class="row-odd"><td><p>nextEventTime</p></td>
<td><p>Model time <span class="math notranslate nohighlight">\(t\)</span> when EnergyPlus needs to be called next (typically the next zone time step).</p></td>
<td><p>s</p></td>
</tr>
</tbody>
</table>
<p>The calling sequences of the functions that send data to EnergyPlus and read data from EnergyPlus is
as for any <a class="reference internal" href="glossary.html#term-continuous-time-variable"><span class="xref std std-term">continuous-time variable</span></a> in FMI. That is, at any time instant,
variables can be set multiple times, and the values returned by EnergyPlus must be computed
using the current input variables. (For example, multiple calls within a time step may be used to compute
the derivative of <code class="docutils literal notranslate"><span class="pre">Q_flow</span></code> with respect to <code class="docutils literal notranslate"><span class="pre">T</span></code>.)</p>
</section>
<section id="retrieving-output-variables-from-energyplus">
<span id="sec-out-var"></span><h4><span class="section-number">5.2.4.4. </span>Retrieving output variables from EnergyPlus<a class="headerlink" href="#retrieving-output-variables-from-energyplus" title="Permalink to this headline">¶</a></h4>
<p>This section describes how to retrieve in Modelica values from the EnergyPlus object
<code class="docutils literal notranslate"><span class="pre">Output:Variable</span></code>.</p>
<p>There is a Modelica block called <code class="docutils literal notranslate"><span class="pre">OutputVariable</span></code> with parameters</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>key</p></td>
<td><p>EnergyPlus key of the output variable</p></td>
</tr>
<tr class="row-odd"><td><p>name</p></td>
<td><p>EnergyPlus name of the output variable as in the EnergyPlus .rdd or .mdd file</p></td>
</tr>
</tbody>
</table>
<p>At each invocation of the function <code class="docutils literal notranslate"><span class="pre">fmi2GetReal</span></code>, EnergyPlus will return the output variable that is computed for
the current time and all the values set with <code class="docutils literal notranslate"><span class="pre">fmi2SetReal</span></code>.
During the initialization, EnergyPlus will return an initial value.</p>
<p>For Modelica, reading variables will be done using a block with no input and one output.</p>
<p>We assume that these variables are <a class="reference internal" href="glossary.html#term-discrete-time-variable"><span class="xref std std-term">discrete-time variables</span></a>
and hence change their values only at events. Specifically, if
<span class="math notranslate nohighlight">\(y(\cdot)\)</span> is a variable of time that is computed in EnergyPlus
that is sampled at some time instant <span class="math notranslate nohighlight">\(t\)</span>,
then Modelica will retrieve <span class="math notranslate nohighlight">\(y(t^+)\)</span>, where
<span class="math notranslate nohighlight">\(t^+ = (\lim_{\epsilon \to 0} (t+\epsilon), t_{I_{max}})\)</span> and
<span class="math notranslate nohighlight">\(I_{max}\)</span> is the largest occurring integer of <a class="reference internal" href="glossary.html#term-superdense-time"><span class="xref std std-term">superdense time</span></a>.</p>
<p>The Modelica pseudo-code is</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">when</span> <span class="p">{</span><span class="kr">initial</span><span class="p">(),</span> <span class="nb">time</span> <span class="o">&gt;=</span> <span class="nb">pre</span><span class="p">(</span><span class="n">tNext</span><span class="p">)}</span> <span class="kr">then</span>
  <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">tNext</span><span class="p">)</span> <span class="o">=</span> <span class="n">readFromEnergyPlus</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">time</span><span class="p">);</span>
<span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">adapter</span></code> stores the data structure used to communicate with EnergyPlus.</p>
</section>
<section id="sending-input-to-energyplus">
<span id="sec-sen-var"></span><h4><span class="section-number">5.2.4.5. </span>Sending input to EnergyPlus<a class="headerlink" href="#sending-input-to-energyplus" title="Permalink to this headline">¶</a></h4>
<p>This section describes how to send Modelica values to the EnergyPlus objects</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ExternalInterface:FunctionalMockupUnitExport:To:Schedule</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ExternalInterface:FunctionalMockupUnitExport:To:Actuator</span></code>.</p></li>
</ol>
<p>For reference, examples of instances in EnergyPlus for these objects are
as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ExternalInterface:FunctionalMockupUnitExport:To:Schedule,
  OfficeSensibleGain,                           !- EnergyPlus Schedule Name
  Any Number,                                   !- Schedule Type Limits Names
  QSensible,                                    !- FMU Variable Name
  0;                                            !- Initial Value

ExternalInterface:FunctionalMockupUnitExport:To:Actuator,
  Zn001_Wall001_Win001_Shading_Deploy_Status,   !- EnergyPlus Variable Name
  Zn001:Wall001:Win001,                         !- Actuated Component Unique Name
  Window Shading Control,                       !- Actuated Component Type
  Control Status,                               !- Actuated Component Control Type
  yShade,                                       !- FMU Variable Name
  6;                                            !- Initial Value
</pre></div>
</div>
<p>For the Modelica coupling, these objects need not be declared in the idf file.</p>
<p>For Modelica, exchanging variables with these objects will be done
using a Modelica block that has only one input and no output.</p>
<p>As in <a class="reference internal" href="#sec-out-var"><span class="std std-numref">Section 5.2.4.4</span></a>,
we assume that these variables are <a class="reference internal" href="glossary.html#term-discrete-time-variable"><span class="xref std std-term">discrete-time variables</span></a>
and hence change their values only at events. Specifically, if
<span class="math notranslate nohighlight">\(u(\cdot)\)</span> is a variable of time that is computed in Modelica
that is sampled at some time instant <span class="math notranslate nohighlight">\(t\)</span>,
then Modelica will send <span class="math notranslate nohighlight">\(u(\mathbin{^-t})\)</span>, where
<span class="math notranslate nohighlight">\(\mathbin{^-t} = (\lim_{\epsilon \to 0} (t-\epsilon), 0)\)</span>.</p>
<p>With this construct, there is no iteration needed if a control loop is closed
between Modelica and EnergyPlus that uses outputs from <a class="reference internal" href="#sec-out-var"><span class="std std-numref">Section 5.2.4.4</span></a>
and inputs from this section.
To see this, consider
a controller in Modelica that will send
a control signal <span class="math notranslate nohighlight">\(u(t)\)</span> to EnergyPlus and retrieve from EnergyPlus a measured
quantity <span class="math notranslate nohighlight">\(y(t)\)</span>.
A specific example is a PI controller in Modelica that actuates
the shade slat angle in EnergyPlus based on indoor illuminance reported by EnergyPlus.
Then, at the time instant <span class="math notranslate nohighlight">\(t\)</span>,
Modelica will send <span class="math notranslate nohighlight">\(u(\mathbin{^-t})\)</span>
and it will retrieve <span class="math notranslate nohighlight">\(y(t^+)\)</span>. Hence, no iteration
across the tools is required. At the next sample time, Modelica will
send the updated control signal that depends on <span class="math notranslate nohighlight">\(y(t^+)\)</span> to EnergyPlus.
This simple example also illustrates that inputs and outputs may need for certain
applications be exchanged at a sampling rate that is below the EnergyPlus zone time step
in order to get satisfactory closed loop control performance.</p>
<section id="schedules">
<span id="sec-inp-sch"></span><h5><span class="section-number">5.2.4.5.1. </span>Schedules<a class="headerlink" href="#schedules" title="Permalink to this headline">¶</a></h5>
<p>There is a Modelica block called <code class="docutils literal notranslate"><span class="pre">Schedule</span></code> with parameters</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>name</p></td>
<td><p>Name of an EnergyPlus schedule.</p></td>
</tr>
<tr class="row-odd"><td><p>unit</p></td>
<td><p>Unit of the variable used as input to this block
(consistent with column <em>Modelica unit</em> in <a class="reference internal" href="#tab-uni-spe"><span class="std std-numref">Table 5.1</span></a> )</p></td>
</tr>
<tr class="row-even"><td><p>useSamplePeriod</p></td>
<td><p>If <code class="docutils literal notranslate"><span class="pre">true</span></code>, sample at zone time step and at sample period</p></td>
</tr>
<tr class="row-odd"><td><p>samplePeriod</p></td>
<td><p>Sample period of component (used if <code class="docutils literal notranslate"><span class="pre">useSamplePeriod</span> <span class="pre">=</span> <span class="pre">true</span></code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As EnergyPlus has no notion of real versus integer (or boolean) variables,
values will be sent as doubles.</p>
</div>
<p>The Modelica pseudo-code is</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">when</span> <span class="nb">sample</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">samplePeriod</span><span class="p">)</span> <span class="kr">then</span>
   <span class="n">sendScheduleToEnergyPlus</span><span class="p">(</span><span class="nb">pre</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">adapter</span><span class="p">);</span>
<span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
</pre></div>
</div>
<p>where
<code class="docutils literal notranslate"><span class="pre">t0</span></code> is the start of the simulation,
<code class="docutils literal notranslate"><span class="pre">samplePeriod</span></code> is the sample period if this block, and
<code class="docutils literal notranslate"><span class="pre">pre(u)</span></code> is the value of the input before <code class="docutils literal notranslate"><span class="pre">sample(t0,</span> <span class="pre">samplePeriod)</span></code> becomes <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
</section>
<section id="actuators">
<span id="sec-inp-act"></span><h5><span class="section-number">5.2.4.5.2. </span>Actuators<a class="headerlink" href="#actuators" title="Permalink to this headline">¶</a></h5>
<p>There is a Modelica block called <code class="docutils literal notranslate"><span class="pre">Actuator</span></code> with parameters</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 78%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>variableName</p></td>
<td><p>Name of the EnergyPlus variable.</p></td>
</tr>
<tr class="row-odd"><td><p>unit</p></td>
<td><p>Unit of the variable used as input to this block
(consistent with column <em>Modelica unit</em> in <a class="reference internal" href="#tab-uni-spe"><span class="std std-numref">Table 5.1</span></a> )</p></td>
</tr>
<tr class="row-even"><td><p>componentName</p></td>
<td><p>Name of the actuated component unique name.</p></td>
</tr>
<tr class="row-odd"><td><p>componentType</p></td>
<td><p>Actuated comonent type.</p></td>
</tr>
<tr class="row-even"><td><p>controlType</p></td>
<td><p>Actuated component control type.</p></td>
</tr>
<tr class="row-odd"><td><p>useSamplePeriod</p></td>
<td><p>If <code class="docutils literal notranslate"><span class="pre">true</span></code>, sample at zone time step and at sample period</p></td>
</tr>
<tr class="row-even"><td><p>samplePeriod</p></td>
<td><p>Sample period of component (used if <code class="docutils literal notranslate"><span class="pre">useSamplePeriod</span> <span class="pre">=</span> <span class="pre">true</span></code>.</p></td>
</tr>
</tbody>
</table>
<div class="admonition-todo admonition" id="id1">
<p class="admonition-title">Todo</p>
<p>Why is the <em>Variable name</em> needed? Should this be left out?</p>
</div>
<p>No entry in the idf file is required to write to an EMS actuator.</p>
<p>The Modelica pseudo-code is</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">when</span> <span class="nb">sample</span><span class="p">(</span><span class="n">t0</span><span class="p">,</span> <span class="n">samplePeriod</span><span class="p">)</span> <span class="kr">then</span>
   <span class="n">sendActuatorToEnergyPlus</span><span class="p">(</span><span class="nb">pre</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">adapter</span><span class="p">);</span>
<span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">pre(u)</span></code> is the value of the input before <code class="docutils literal notranslate"><span class="pre">sample(t0,</span> <span class="pre">samplePeriod)</span></code> becomes <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
</section>
</section>
</section>
<section id="api-used-to-export-energyplus-as-an-fmu">
<span id="sec-req-ene-exp-fmu"></span><h3><span class="section-number">5.2.5. </span>API used to Export EnergyPlus as an FMU<a class="headerlink" href="#api-used-to-export-energyplus-as-an-fmu" title="Permalink to this headline">¶</a></h3>
<p>To export EnergyPlus as an FMU for model exchange, EnergyPlus provides an executable that
reads a json configuration file and packages EnergyPlus as an FMU for Model Exchange 2.0.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the current implementation, we assume that EnergyPlus does not support roll back in time.
This will otherwise require EnergyPlus to be able to save and restore its complete internal state.
This internal state consists especially of the values of the continuous-time states,
iteration variables, parameter values, input values, delay buffers, file identifiers and internal status information.
This limitation is indicated in the model description file with the capability flag <code class="docutils literal notranslate"><span class="pre">canGetAndSetFMUstate</span></code>
being set to <code class="docutils literal notranslate"><span class="pre">false</span></code>. If this capability were supported, then EnergyPlus could be used
with ODE solvers which can reject and repeat steps. Rejecting steps is needed by ODE solvers
such as DASSL or even Euler with step size control (but not for QSS)
as they may reject a step size if the error is too large.
Also, rejecting steps is needed to identify state events (but not for QSS solvers).</p>
</div>
<section id="instantiation">
<span id="sec-int-c-api"></span><h4><span class="section-number">5.2.5.1. </span>Instantiation<a class="headerlink" href="#instantiation" title="Permalink to this headline">¶</a></h4>
<p>To instantiate EnergyPlus, EnergyPlus generates an FMU 2.0 for model exchange.
This is initiated by Modelica, which invokes a system command of the form</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spawn path_to_json
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">spawn</span></code> is a program provided by EnergyPlus, and <code class="docutils literal notranslate"><span class="pre">path_to_json</span></code>
is the absolute path of the json file <code class="docutils literal notranslate"><span class="pre">ModelicaBuildingsEnergyPlus.json</span></code> that configures EnergyPlus.
For the case of a model with one thermal zone, the content of this file looks as follows:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="w"></span>
<span class="w"> </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w"> </span><span class="nt">&quot;EnergyPlus&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="nt">&quot;idf&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/tmp/tmp-spawn/jm_tmpPVJfHP/resources/0/RefBldgSmallOfficeNew2004_Chicago.idf&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="nt">&quot;idd&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/tmp/tmp-spawn/jm_tmpPVJfHP/resources/2/Energy+.idd&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="nt">&quot;weather&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/tmp/tmp-spawn/jm_tmpPVJfHP/resources/1/USA_IL_Chicago-OHare.Intl.AP.725300_TMY3.epw&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="nt">&quot;autosize&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="nt">&quot;runSimulationForSizingPeriods&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"></span>
<span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w"> </span><span class="nt">&quot;fmu&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/mnt/shared/modelica-buildings/tmp-eplus-fmuName/fmuName.fmu&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">     </span><span class="nt">&quot;kind&quot;</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ME&quot;</span><span class="w"></span>
<span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w"> </span><span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="nt">&quot;zones&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">         </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;office&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="p">],</span><span class="w"></span>
<span class="w">     </span><span class="nt">&quot;hvacZones&quot;</span><span class="p">:[</span><span class="w"></span>
<span class="w">       </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;office_and_core_zones&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="nt">&quot;zones&quot;</span><span class="p">:</span><span class="w"></span>
<span class="w">         </span><span class="p">[</span><span class="w"></span>
<span class="w">           </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;office&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">           </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;core&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">         </span><span class="p">]</span><span class="w"></span>
<span class="w">       </span><span class="p">},</span><span class="w"></span>
<span class="w">       </span><span class="p">{</span><span class="w"></span>
<span class="w">         </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;south zones&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="nt">&quot;zones&quot;</span><span class="p">:</span><span class="w"></span>
<span class="w">         </span><span class="p">[</span><span class="w"></span>
<span class="w">           </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;southWest&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">           </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;southEast&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">         </span><span class="p">]</span><span class="w"></span>
<span class="w">       </span><span class="p">}</span><span class="w"></span>
<span class="w">     </span><span class="p">]</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Using this information, EnergyPlus creates the FMU with name
<code class="docutils literal notranslate"><span class="pre">/mnt/shared/modelica-buildings/tmp-eplus-fmuName/fmuName.fmu</span></code>.</p>
<p>Depending on the boolean entry <code class="docutils literal notranslate"><span class="pre">autosize</span></code>, EnergyPlus will conduct an autosizing calculation.
If <code class="docutils literal notranslate"><span class="pre">autosize:</span> <span class="pre">true</span></code>, then <code class="docutils literal notranslate"><span class="pre">runSimulationForSizingPeriods</span></code> determines whether
the simulation will be run on all the included <code class="docutils literal notranslate"><span class="pre">SizingPeriod</span></code> objects in the idf file
(i.e., <code class="docutils literal notranslate"><span class="pre">SizingPeriod:DesignDay</span></code>, <code class="docutils literal notranslate"><span class="pre">SizingPeriod:WeatherFileDays</span></code>, and <code class="docutils literal notranslate"><span class="pre">SizingPeriod:WeatherFileConditionType</span></code>).</p>
<p>We will now describe how to the exchanged variables are configured.</p>
<section id="envelope-model">
<h5><span class="section-number">5.2.5.1.1. </span>Envelope model<a class="headerlink" href="#envelope-model" title="Permalink to this headline">¶</a></h5>
<p>To configure the variables to be exchanged for the envelope model described in <a class="reference internal" href="#sec-cou-env"><span class="std std-numref">Section 5.2.4.1</span></a>,
the following data structures will be used for a building with a zone called <code class="docutils literal notranslate"><span class="pre">basement</span></code> and a zone called <code class="docutils literal notranslate"><span class="pre">office</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;zones&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;basement&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;office&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<p>In this case, the FMU must have parameters called <code class="docutils literal notranslate"><span class="pre">basement_V</span></code>, <code class="docutils literal notranslate"><span class="pre">office_V</span></code>, <code class="docutils literal notranslate"><span class="pre">basement_AFlo</span></code> etc.
inputs called <code class="docutils literal notranslate"><span class="pre">basement_T</span></code> and <code class="docutils literal notranslate"><span class="pre">office_T</span></code> and outputs called
<code class="docutils literal notranslate"><span class="pre">basement_QConSen_flow</span></code> and <code class="docutils literal notranslate"><span class="pre">office_QConSen_flow</span></code>.</p>
</section>
<section id="hvac-zones-used-for-auto-sizing">
<h5><span class="section-number">5.2.5.1.2. </span>HVAC zones used for auto-sizing<a class="headerlink" href="#hvac-zones-used-for-auto-sizing" title="Permalink to this headline">¶</a></h5>
<p>The entry <code class="docutils literal notranslate"><span class="pre">hvacZones</span></code> is used to group thermal zones for autosizing. Its syntax is</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;hvacZones&quot;</span><span class="o">:</span><span class="p">[</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;office_and_core_zones&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;zones&quot;</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;office&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;core&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">},</span><span class="w"></span>
<span class="w">  </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;south_zones&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;zones&quot;</span><span class="o">:</span><span class="w"></span>
<span class="w">    </span><span class="p">[</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;southWest&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;southEast&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">]</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<p>The length of <code class="docutils literal notranslate"><span class="pre">hvacZones</span></code> may be zero for the special case of
the Modelica model having no <code class="docutils literal notranslate"><span class="pre">ThermalZone</span></code> specified.
Modelica ensures that there is always a <code class="docutils literal notranslate"><span class="pre">hvacZones</span></code> entry.</p>
<p>For the above example, the FMU must have parameters called</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_QCooSen_flow</span></code> for sensible cooling load,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_QCooLat_flow</span></code> for latent cooling load,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_TOutCoo</span></code> for outdoor drybulb temperature at the cooling design load,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_XOutCoo</span></code> for outdoor humidity ratio at the cooling design load,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_tCoo</span></code> time at which these loads occurred,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_QHea_flow</span></code> for heating load,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_TOutHea</span></code> for outdoor drybulb temperature at the heating design load,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_XOutHea</span></code> for outdoor humidity ratio at the heating design load,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_mOutCoo_flow</span></code> for minimum outdoor air flow rate during the cooling design load,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_mOutHea_flow</span></code> for minimum outdoor air flow rate during the heating design load, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hvac_sizing_group_xxx_tHea</span></code> time at which these loads occurred,</p></li>
</ul>
<p>where <code class="docutils literal notranslate"><span class="pre">xxx</span></code> is <code class="docutils literal notranslate"><span class="pre">office_and_core_zones</span></code> and <code class="docutils literal notranslate"><span class="pre">south_zones</span></code>, respectively.
The quantities <code class="docutils literal notranslate"><span class="pre">*Coo*</span></code> and <code class="docutils literal notranslate"><span class="pre">*Hea*</span></code> are at the respective time step that determines
the sizing as specified by <code class="docutils literal notranslate"><span class="pre">*tCoo</span></code> and <code class="docutils literal notranslate"><span class="pre">*tHea</span></code>.
The exchanged parameters include outdoor mass flow rates and outdoor condition to allow for fully automatic
system sizing through Modelica parameter expressions.
The units are <code class="docutils literal notranslate"><span class="pre">[W]</span></code>, <code class="docutils literal notranslate"><span class="pre">degC</span></code>,  <code class="docutils literal notranslate"><span class="pre">kg/kg</span></code> water vapor mass fraction per total air mass of the zone,
<code class="docutils literal notranslate"><span class="pre">[s]</span></code> since January 1 at 0:00:00, and <code class="docutils literal notranslate"><span class="pre">kg/s</span></code>.
All quantities are after applying all EnergyPlus zone and group multipliers.</p>
<p>Similarly, for each thermal zone, there will be parameters in the FMU as above,
but with <code class="docutils literal notranslate"><span class="pre">group</span></code> replaced by <code class="docutils literal notranslate"><span class="pre">zone</span></code> and the zone name inserted, such as in
<code class="docutils literal notranslate"><span class="pre">hvac_sizing_zone_office_QCooSen_flow</span></code>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">autosizing:</span> <span class="pre">false</span></code>, then these values must not be in the <code class="docutils literal notranslate"><span class="pre">modelDescription.xml</span></code> file.</p>
</section>
<section id="opaque-construction">
<h5><span class="section-number">5.2.5.1.3. </span>Opaque construction<a class="headerlink" href="#opaque-construction" title="Permalink to this headline">¶</a></h5>
<p>To configure the variables to be exchanged for an opaque construction that is part of an EnergyPlus thermal zone as described in <a class="reference internal" href="#sec-cou-opa-con"><span class="std std-numref">Section 5.2.4.2</span></a>,
the following data structures will be used for a building with an EnergyPlus surface called <code class="docutils literal notranslate"><span class="pre">north</span> <span class="pre">ceiling</span> <span class="pre">office</span></code> and a zone called <code class="docutils literal notranslate"><span class="pre">south</span> <span class="pre">ceiling</span> <span class="pre">office</span></code>.
(This requires to add a surface object to EnergyPlus, including all information needed by EnergyPlus such
as the surface location and its solar and infrared emissivity.)</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;buildingSurfaceDetailed&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;north ceiling office&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;south ceiling office&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="zone-surface">
<h5><span class="section-number">5.2.5.1.4. </span>Zone surface<a class="headerlink" href="#zone-surface" title="Permalink to this headline">¶</a></h5>
<p>To configure the variables to be exchanged for a surface that is part of an EnergyPlus thermal zone as described in <a class="reference internal" href="#sec-cou-zon-sur"><span class="std std-numref">Section 5.2.4.3</span></a>,
the following data structures will be used for a building with an EnergyPlus surface called <code class="docutils literal notranslate"><span class="pre">north</span> <span class="pre">ceiling</span> <span class="pre">office</span></code> and a zone called <code class="docutils literal notranslate"><span class="pre">south</span> <span class="pre">ceiling</span> <span class="pre">office</span></code>.
(This requires to add a surface object to EnergyPlus, including all information needed by EnergyPlus such
as the surface location and its solar and infrared emissivity.)</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="s">&quot;zoneSurfaces&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;north ceiling office&quot;</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s">&quot;south ceiling office&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">]</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="output-variables">
<h5><span class="section-number">5.2.5.1.5. </span>Output variables<a class="headerlink" href="#output-variables" title="Permalink to this headline">¶</a></h5>
<p>To configure the data exchange for output variables, as described in <a class="reference internal" href="#sec-out-var"><span class="std std-numref">Section 5.2.4.4</span></a>,
consider an example where one wants to retrieve the outdoor drybulb temperature from EnergyPlus.</p>
<p>The corresponsding section in the <code class="docutils literal notranslate"><span class="pre">ModelicaBuildingsEnergyPlus.json</span></code> configuration file is</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;model&quot;</span><span class="o">:</span> <span class="p">{</span>
   <span class="s2">&quot;outputVariables&quot;</span><span class="o">:</span> <span class="p">[</span>
     <span class="p">{</span>
       <span class="s2">&quot;name&quot;</span><span class="o">:</span>    <span class="s2">&quot;Site Outdoor Air Drybulb Temperature&quot;</span><span class="p">,</span>
       <span class="s2">&quot;key&quot;</span><span class="o">:</span>     <span class="s2">&quot;Environment&quot;</span><span class="p">,</span>
       <span class="s2">&quot;fmiName&quot;</span><span class="o">:</span> <span class="s2">&quot;Environment Site Outdoor Air Drybulb Temperature&quot;</span>
     <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>EnergyPlus will then declare in the <code class="docutils literal notranslate"><span class="pre">modelDescription.xml</span></code> file an output variable with name as shown in
<code class="docutils literal notranslate"><span class="pre">outputVariables.fmiName</span></code> and units consistent with <a class="reference internal" href="#tab-uni-spe"><span class="std std-numref">Table 5.1</span></a>.</p>
</section>
<section id="id2">
<h5><span class="section-number">5.2.5.1.6. </span>Schedules<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h5>
<p>To configure the data exchange for schedules, as described in <a class="reference internal" href="#sec-inp-sch"><span class="std std-numref">Section 5.2.4.5.1</span></a>,
consider an example where one wants to write to an EnergyPlus schedule called <code class="docutils literal notranslate"><span class="pre">Lights</span></code>.</p>
<p>The corresponsding section in the <code class="docutils literal notranslate"><span class="pre">ModelicaBuildingsEnergyPlus.json</span></code> configuration file is</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;model&quot;</span><span class="o">:</span> <span class="p">{</span>
   <span class="s2">&quot;schedules&quot;</span><span class="o">:</span> <span class="p">[</span>
     <span class="p">{</span>
       <span class="s2">&quot;name&quot;</span>    <span class="o">:</span> <span class="s2">&quot;Lights&quot;</span><span class="p">,</span>
       <span class="s2">&quot;unit&quot;</span>    <span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="c1">// Unit string as shown in column &quot;EnergyPlus Unit String&quot; in the above table</span>
       <span class="s2">&quot;fmiName&quot;</span> <span class="o">:</span> <span class="s2">&quot;schedule Lights&quot;</span>
     <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>EnergyPlus will then declare in the <code class="docutils literal notranslate"><span class="pre">modelDescription.xml</span></code> file an input variable with name as shown in
<code class="docutils literal notranslate"><span class="pre">schedules.fmiName</span></code> and unit listed in <code class="docutils literal notranslate"><span class="pre">schedules.unit</span></code>.
Modelica will write to this schedule with units shown in the column <em>EnergyPlus Unit String</em>
in <a class="reference internal" href="#tab-uni-spe"><span class="std std-numref">Table 5.1</span></a>.</p>
</section>
<section id="ems-actuators">
<h5><span class="section-number">5.2.5.1.7. </span>EMS actuators<a class="headerlink" href="#ems-actuators" title="Permalink to this headline">¶</a></h5>
<p>To configure the data exchange for schedules, as described in <a class="reference internal" href="#sec-inp-act"><span class="std std-numref">Section 5.2.4.5.2</span></a>,
consider an example where one wants to write to an EnergyPlus schedule called <code class="docutils literal notranslate"><span class="pre">Lights</span></code>.</p>
<p>The corresponsding section in the <code class="docutils literal notranslate"><span class="pre">ModelicaBuildingsEnergyPlus.json</span></code> configuration file is</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;model&quot;</span><span class="o">:</span> <span class="p">{</span>
   <span class="s2">&quot;emsActuators&quot;</span><span class="o">:</span> <span class="p">[</span>
     <span class="p">{</span>
       <span class="s2">&quot;name&quot;</span>          <span class="o">:</span> <span class="s2">&quot;Zn001_Wall001_Win001_Shading_Deploy_Status&quot;</span><span class="p">,</span>
       <span class="s2">&quot;variableName&quot;</span>  <span class="o">:</span> <span class="s2">&quot;Zn001:Wall001:Win001&quot;</span><span class="p">,</span>
       <span class="s2">&quot;componentType&quot;</span> <span class="o">:</span> <span class="s2">&quot;Window Shading Control&quot;</span><span class="p">,</span>
       <span class="s2">&quot;controlType&quot;</span>   <span class="o">:</span> <span class="s2">&quot;Control Status&quot;</span><span class="p">,</span>
       <span class="s2">&quot;unit&quot;</span>          <span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="c1">// Unit string as shown in column &quot;EnergyPlus Unit String&quot; in the above table</span>
       <span class="s2">&quot;fmiName&quot;</span>       <span class="o">:</span> <span class="s2">&quot;yShade&quot;</span>
     <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>EnergyPlus will then declare in the <code class="docutils literal notranslate"><span class="pre">modelDescription.xml</span></code> file an input variable with name as shown in
<code class="docutils literal notranslate"><span class="pre">emsActuators.fmiName</span></code> and unit listed in <code class="docutils literal notranslate"><span class="pre">emsActuators.unit</span></code>.
Modelica will write to this EMS actuator with units shown in the column <em>EnergyPlus Unit String</em>
in <a class="reference internal" href="#tab-uni-spe"><span class="std std-numref">Table 5.1</span></a>.</p>
</section>
</section>
</section>
<section id="time-synchronization">
<span id="sec-time-sync"></span><h3><span class="section-number">5.2.6. </span>Time synchronization<a class="headerlink" href="#time-synchronization" title="Permalink to this headline">¶</a></h3>
<figure class="align-default" id="id7">
<span id="fig-fmi-me-20-state-machine"></span><a class="reference internal image-reference" href="_images/StateMachineModelExchange.png"><img alt="_images/StateMachineModelExchange.png" src="_images/StateMachineModelExchange.png" style="width: 736.0px; height: 583.0px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 5.3 </span>: Calling sequence of Model Exchange C functions in form of an UML 2.0 state machine (Figure
reproduced from <span id="id3">[<a class="reference internal" href="zreferences.html#id24" title="MODELISAR Consortium. Functional Mock-up Interface for Model-Exchange and Co-Simulation. 2014. \url https://www.fmi-standard.org/downloads.">MODELISARConsortium14</a>]</span>.</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p><a class="reference internal" href="#fig-fmi-me-20-state-machine"><span class="std std-numref">Fig. 5.3</span></a> shows the state machine for calling an FMU 2.0 for Model Exchange.
To communicate with EnergyPlus, we are using the same API and calling sequence.
The EnergyPlus envelope model is invoked at a variable time step, using a Modelica time event.
In the implementation, EnergyPlus sends the time instant when it needs to be called the next time.
<a class="reference internal" href="#fig-partition-envelope-room-hvac"><span class="std std-numref">Fig. 5.2</span></a> shows this as the EnergyPlus time step, but the Modelica
implementation allows for any time step requested by EnergyPlus.
Therefore, for the envelope model, data is exchanged within the mode labelled <em>Continuous Time Mode</em>
in <a class="reference internal" href="#fig-fmi-me-20-state-machine"><span class="std std-numref">Fig. 5.3</span></a>.
Internally, EnergyPlus samples its heat conduction model at the envelope time step <span class="math notranslate nohighlight">\(\Delta t_z\)</span>.
EnergyPlus needs to report this to the FMI interface. To report such time events,
the FMI interface uses a C structure called <code class="docutils literal notranslate"><span class="pre">fmi2EventInfo</span></code> which is implemented as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">fmi2Boolean</span><span class="w"> </span><span class="n">newDiscreteStatesNeeded</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fmi2Boolean</span><span class="w"> </span><span class="n">terminateSimulation</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fmi2Boolean</span><span class="w"> </span><span class="n">nominalsOfContinuousStatesChanged</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fmi2Boolean</span><span class="w"> </span><span class="n">valuesOfContinuousStatesChanged</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fmi2Boolean</span><span class="w"> </span><span class="n">nextEventTimeDefined</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">fmi2Real</span><span class="w"></span>
<span class="w">  </span><span class="n">nextEventTime</span><span class="p">;</span><span class="w"> </span><span class="c1">// next event if nextEventTimeDefined=fmi2True</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">fmi2EventInfo</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>The variable <code class="docutils literal notranslate"><span class="pre">nextEventTime</span></code> needs to be set to the time when the next event happens
in EnergyPlus. This is, for example, whenever the envelope model advances time,
or when a schedule changes its value and this change affects the variables
that are sent from the EnergyPlus FMU to the master algorithm.
Such a schedule could for example be a time schedule for internal heat gains,
which may change at times that do not coincide with the zone time step <span class="math notranslate nohighlight">\(\Delta t_z\)</span>.</p>
<p>Reading outputs and sending inputs to schedule,
and EMS actuators
happens in the mode labelled <em>EventMode</em>.
This allows to avoid algebraic loops that may be formed by adding a controller
between an EnergyPlus output and an EnergyPlus input, as described in <a class="reference internal" href="#sec-sen-var"><span class="std std-numref">Section 5.2.4.5</span></a>.</p>
</section>
</section>
<section id="distribution-of-spawn-and-the-modelica-buildings-library">
<span id="sec-dist"></span><h2><span class="section-number">5.3. </span>Distribution of Spawn and the Modelica Buildings Library<a class="headerlink" href="#distribution-of-spawn-and-the-modelica-buildings-library" title="Permalink to this headline">¶</a></h2>
<p>This section describes how Spawn and the Modelica Buildings Library coupling with Spawn
needs to be set up for development and distribution.</p>
<p>First, recall that there are three distinct phases of a Modelica model life cycle,
namely</p>
<ol class="arabic simple">
<li><p>the translation from Modelica to a binary (an FMU or an executable),</p></li>
<li><p>the initialization of the model, and</p></li>
<li><p>the time-domain simulation of the model (including the termination of the simulation).</p></li>
</ol>
<p>Also, there are two FMUs involved. One is the <em>Modelica FMU</em>
which is the FMU that contains the compiled Modelica code, and the other is the
<em>EnergyPlus FMU</em> that contains the EnergyPlus model.
Note that for simulation, OPTIMICA generates the Modelica FMU,
but other tools like OpenModelica or Dymola generate for simulation an executable instead of the Modelica FMU.
Below, we always refer to the Modelica FMU, but without loss of generality, the Modelica FMU is
interchangeable with the executable generated by OpenModelica or Dymola.</p>
<p>During the <em>translation</em> phase of a Modelica model, Spawn is not used.
Rather, Modelica FMUs that contains Spawn models invoke during the <em>initialization</em> phase an executable
called <cite>spawn</cite>. This generates the EnergyPlus FMU, which is then automatically coupled to the Modelica model
during the initialization of the Modelica model.</p>
<p>During the <em>simulation</em> phase, the Modelica FMU calls functions in the EnergyPlus FMU to synchronize
the simulation of the two programs, and eventually the Modelica FMU sends a signal to the EnergyPlus FMU
to shut down EnergyPlus.</p>
<p>In the Modelica Buildings Library version 8.0, the Spawn binaries are distributed
as part of the Modelica release
download (on <a class="reference external" href="https://simulationresearch.lbl.gov/modelica/downloads/archive/modelica-buildings.html">https://simulationresearch.lbl.gov/modelica/downloads/archive/modelica-buildings.html</a>)
and integrated with git on <a class="reference external" href="https://github.com/lbl-srg/modelica-buildings">https://github.com/lbl-srg/modelica-buildings</a> using git-lfs.
The EnergyPlus binaries for Linux and Windows are about 160MB, and stored in the Modelica Buildings Library as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Resources/bin/
├── spawn-linux64
│   ├── bin
│   │   └── spawn
│   ├── etc
│   │   └── Energy+.idd
│   ├── lib
│   │   └── epfmi.so
│   └── README.md
└── spawn-win64
    ├── bin
    │   ├── epfmi.dll
    │   ├── spawn.exe
    │   └── VCRUNTIME140.dll
    ├── etc
    │   └── Energy+.idd
    ├── lib
    │   └── epfmi.lib
    └── README.md
</pre></div>
</div>
<p>The <cite>spawn</cite> executable needs to access the library <cite>epfmi.so</cite> (or <cite>epfmi.lib</cite>) and the <cite>Energy+.idd</cite> file.
This library is part of the EnergyPlus FMU generated by <cite>spawn</cite>. For example, an EnergyPlus FMU contains</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modelDescription</span><span class="o">.</span><span class="n">xml</span>
<span class="n">binaries</span><span class="o">/</span><span class="n">linux64</span><span class="o">/</span><span class="n">epfmi</span><span class="o">.</span><span class="n">so</span>
<span class="n">resources</span><span class="o">/</span><span class="n">SingleFamilyHouse_TwoSpeed_ZoneAirBalance</span><span class="o">.</span><span class="n">idf</span>
<span class="n">resources</span><span class="o">/</span><span class="n">USA_IL_Chicago</span><span class="o">-</span><span class="n">OHare</span><span class="o">.</span><span class="n">Intl</span><span class="o">.</span><span class="n">AP</span><span class="mf">.725300</span><span class="n">_TMY3</span><span class="o">.</span><span class="n">epw</span>
<span class="n">resources</span><span class="o">/</span><span class="n">Energy</span><span class="o">+.</span><span class="n">idd</span>
<span class="n">resources</span><span class="o">/</span><span class="n">model</span><span class="o">.</span><span class="n">spawn</span>
</pre></div>
</div>
<p>The FMI Standard ensures that <cite>binaries/linux64/epfmi.so</cite> is found during simulation.
(This file is about 60 MB.)</p>
<p>A Modelica FMU, generated with models from Buildings 8.0, is about 1 MB large and contains files such as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">modelDescription</span><span class="o">.</span><span class="n">xml</span>
<span class="n">binaries</span><span class="o">/</span>
<span class="n">binaries</span><span class="o">/</span><span class="n">linux64</span><span class="o">/</span>
<span class="n">binaries</span><span class="o">/</span><span class="n">linux64</span><span class="o">/</span><span class="n">Buildings_ThermalZones_EnergyPlus_Examples_SingleFamilyHouse_AirHeating</span><span class="o">.</span><span class="n">so</span>
<span class="n">binaries</span><span class="o">/</span><span class="n">linux64</span><span class="o">/</span><span class="n">libModelicaBuildingsEnergyPlus</span><span class="o">.</span><span class="n">so</span>
<span class="n">binaries</span><span class="o">/</span><span class="n">linux64</span><span class="o">/</span><span class="n">libfmilib_shared</span><span class="o">.</span><span class="n">so</span>
<span class="n">resources</span><span class="o">/</span>
</pre></div>
</div>
<p>It turns out that including <code class="docutils literal notranslate"><span class="pre">spawn</span></code> and its dependencies in the Modelica FMU is not a robust option since tools that export Modelica
models as an FMU may change the directory name and remove the executable flag for security reasons.
Moreover, this would lead to very large Modelica FMU file size.</p>
<p>Therefore, a better solution is as follows:</p>
<ol class="arabic simple">
<li><p>Developers of the Modelica Buildings Library, and users (or services such as BOPTEST) that obtain a Modelica FMU with a Spawn model,
have to install Spawn and its dependencies on the target computer, and make sure the <code class="docutils literal notranslate"><span class="pre">spawn</span></code> binary is on the system PATH
environment variable.</p></li>
<li><p>The Modelica Buildings Library installation file, e.g., <a class="reference external" href="https://github.com/lbl-srg/modelica-buildings/releases/download/v8.0.0/Buildings-v8.0.0.zip">https://github.com/lbl-srg/modelica-buildings/releases/download/v8.0.0/Buildings-v8.0.0.zip</a>
contains all files needed to locally translate and simulate a Modelica model that contains Spawn.
However, the github repository does no longer contain these binaries.
Providing all required files, as is done in <code class="docutils literal notranslate"><span class="pre">Buildings-v8.0.0.zip</span></code>, allows IMPACT, Dymola or OpenModelica users to install the library
and all its Spawn dependencies with a command such as
<code class="docutils literal notranslate"><span class="pre">wget</span> <span class="pre">xyz/Buildings-v8.0.0.zip</span> <span class="pre">&amp;&amp;</span> <span class="pre">unzip</span> <span class="pre">Buildings-v8.0.0.zip</span></code>.</p></li>
<li><p>The software that creates the Spawn installer includes the version of the Modelica Buildings Library
that it can download from the github repository (not the zipped version), and hence does not contain the binaries.</p></li>
</ol>
<p>The requirements for such an installation are as follows:</p>
<ol class="arabic simple">
<li><p>It must be possible to have multiple versions of the Modelica Buildings Library installed, and
each version must be able to link to a specific version of the Spawn binaries.
For example, Buildings 8.0.0 may link to spawn version 0.1 while Buildings 8.1.0 may link to Spawn 0.2.</p></li>
<li><p>Developers of the Modelica Buildings Library need to be able to install multiple versions of Spawn, e.g., Spawn 0.1 and 0.2,
and the opened Modelica Buildings Library needs to invoke the version of Spawn used by the particular commit of the
Modelica Buildings Library.</p></li>
<li><p>It must be possible to install Spawn on server hosted environments, such as the BOPTEST server installation or IMPACT,
in a way that models or FMUs from the Modelica Buildings Library find this installation.</p></li>
<li><p>It must be possible to exchange a Modelica FMU, that then contains the idf and epw file.</p></li>
</ol>
<p>To satisfy these requirements, the following setup will be implemented in Buildings 9.0 and Spawn 0.2:</p>
<ol class="arabic">
<li><p>The idf and epw file are part of the generated Modelica FMU.</p></li>
<li><p>Each build of the spawn executable has a unique name, such as <code class="docutils literal notranslate"><span class="pre">spawn-0.2.0-a23bb23</span></code>. (Hash codes are needed for development iterations,
and ideally remain in the final distribution.)</p></li>
<li><p>The Modelica code tries to invoke the spawn executable in this order:</p>
<ol class="arabic simple">
<li><p>Check for <code class="docutils literal notranslate"><span class="pre">Buildings[</span> <span class="pre">x.y.z]/Resources/bin/spawn-[linux64,win64]/bin/spawn-0.2.0-a23bb23[.exe]</span></code> where
<code class="docutils literal notranslate"><span class="pre">Buildings[</span> <span class="pre">x.y.z]</span></code> is the installation folder of the Modelica Buildings Library.</p></li>
<li><p>Check on the environment variable <code class="docutils literal notranslate"><span class="pre">SPAWNPATH</span></code> for <code class="docutils literal notranslate"><span class="pre">spawn-0.2.0-a23bb23[.exe]</span></code>.</p></li>
<li><p>Check on the environment variable <code class="docutils literal notranslate"><span class="pre">PATH</span></code> for <code class="docutils literal notranslate"><span class="pre">spawn-0.2.0-a23bb23[.exe]</span></code>.</p></li>
</ol>
<p>If none of this succeeds, it will report an error.</p>
</li>
<li><p>The spawn executable does not have dependencies other than the idf and epw file that a Modelica FMU needs to know.
In particular, the <code class="docutils literal notranslate"><span class="pre">spawn</span></code> executable finds its libraries and its idd file relative to its folder.</p></li>
<li><p>The Spawn installation can be fully automated using a permanent download location (to be used in documentation and error messages).</p></li>
<li><p>The Spawn installation allows to extract the files (executable, libraries, idd and license files) that need to be added to the
Modelica Buildings Library distribution (e.g., to <code class="docutils literal notranslate"><span class="pre">Buildings-v9.0.0.zip</span></code>).</p></li>
</ol>
</section>
<section id="integration-of-qss-solver-with-optimica">
<span id="sec-qss-jmo-int"></span><h2><span class="section-number">5.4. </span>Integration of QSS solver with OPTIMICA<a class="headerlink" href="#integration-of-qss-solver-with-optimica" title="Permalink to this headline">¶</a></h2>
<p>This section describes the integration of the QSS solver in OPTIMICA.</p>
<p>We will first introduce terminology.
Consider the code-snippet</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kr">when</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="kr">then</span>
  <span class="o">...</span>
<span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>We will say that <span class="math notranslate nohighlight">\(z = a - x\)</span> is the <em>event indicator</em>.</p>
<p>For the discussion, we consider a system of initial value ODEs of the form</p>
<div class="math notranslate nohighlight" id="equation-eqn-ini-val">
<span class="eqno">(5.1)<a class="headerlink" href="#equation-eqn-ini-val" title="Permalink to this equation">¶</a></span>\[ \begin{align}\begin{aligned}\left[\dot x_c(t), x_d(t)\right] = f(x_c(t), x_d(t^-), u_c(t), u_d(t), p, t),\\\begin{split}\left[y_c(t), y_d(t)\right]  = g(x_c(t), x_d(t), u_c(t), u_d(t), p, t),\\\end{split}\\\begin{split}0          = z(x_c(t), x_d(t), u_c(t), u_d(t), p, t),\\\end{split}\\\left[x_c(t_0), x_d(t_0)\right]  = [x_{c,0}, x_{d,0}],\end{aligned}\end{align} \]</div>
<p>where
<span class="math notranslate nohighlight">\(x(\cdot)\)</span> is the continuous-time state vector, with superscript
<span class="math notranslate nohighlight">\(c\)</span> denoting continuous-time states and <span class="math notranslate nohighlight">\(d\)</span> denoting discrete variables or states,
<span class="math notranslate nohighlight">\(u(\cdot)\)</span> is the external input,
<span class="math notranslate nohighlight">\(p\)</span> are parameters,
<span class="math notranslate nohighlight">\(f(\cdot, \cdot, \cdot, \cdot, \cdot, \cdot)\)</span> is the state transitions function,
<span class="math notranslate nohighlight">\(g(\cdot, \cdot, \cdot, \cdot, \cdot, \cdot)\)</span> is the output function,
<span class="math notranslate nohighlight">\(z(\cdot, \cdot, \cdot, \cdot, \cdot, \cdot)\)</span> is the event indicator (sometimes called zero crossing function).</p>
<p>Because we anticipate that the FMU can have
direct feed-through from the input
<span class="math notranslate nohighlight">\(u(t)\)</span> to the output <span class="math notranslate nohighlight">\(y(t)\)</span>, we use
FMI for Model-Exchange (FMI-ME) version 2.0, because the Co-Simulation
standard does not allow a zero time step size as needed for direct feed-through.</p>
<p><a class="reference internal" href="#fig-sof-arc-qss-jmod2"><span class="std std-numref">Fig. 5.4</span></a> shows the software architecture
with the extended FMI API.</p>
<figure class="align-default" id="id8">
<span id="fig-sof-arc-qss-jmod2"></span><p class="plantuml">
<object data="_images/plantuml-2b0f431781c4d10ed5565baa232d436815fb4ae6.svg" type="image/svg+xml" style="width:851px;height:72px;">
<img src="_images/plantuml-2b0f431781c4d10ed5565baa232d436815fb4ae6.png" alt="skinparam componentStyle uml2

[QSS solver] as qss_sol
[FMU-ME] as FMU_QSS
[OPTIMICA compiler] as oct

qss_sol -left-&gt; FMU_QSS : &quot;inputs, time, states&quot;
FMU_QSS -right-&gt; qss_sol : &quot;derivatives&quot;
oct -right-&gt; FMU_QSS : generate FMU with information for QSS"/>

</object></p>
<figcaption>
<p><span class="caption-number">Fig. 5.4 </span>: Software architecture for QSS integration with OPTIMICA
with extended FMI API.</span><a class="headerlink" href="#id8" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The QSS solvers require the derivatives shown in <a class="reference internal" href="#tab-qss-der"><span class="std std-numref">Table 5.2</span></a>.</p>
<span id="tab-qss-der"></span><table class="docutils align-default" id="id9">
<caption><span class="caption-number">Table 5.2 </span><span class="caption-text">Derivatives required by QSS algorithms. One asteriks indicates
        that they are provided by FMI-ME 2.0, and two asteriks indicate
        that they can optionally be computed exactly if directional
        derivatives are provided by the FMU.
        The others cannot be provided through the FMI API.</span><a class="headerlink" href="#id9" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 10%" />
<col style="width: 50%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Type of QSS</p></th>
<th class="head"><p>Continuous-time state derivative</p></th>
<th class="head"><p>event indicator derivative</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>QSS1</p></td>
<td><p><span class="math notranslate nohighlight">\(dx_c/dt\)</span> *</p></td>
<td><p><span class="math notranslate nohighlight">\(dz/dt\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>QSS2</p></td>
<td><p><span class="math notranslate nohighlight">\(dx_c/dt\)</span> * , <span class="math notranslate nohighlight">\(d^2x_c/dt^2\)</span> **</p></td>
<td><p><span class="math notranslate nohighlight">\(dz/dt\)</span> , <span class="math notranslate nohighlight">\(d^2z/dt^2\)</span></p></td>
</tr>
<tr class="row-even"><td><p>QSS3</p></td>
<td><p><span class="math notranslate nohighlight">\(dx_c/dt\)</span> * , <span class="math notranslate nohighlight">\(d^2x_c/dt^2\)</span> ** , <span class="math notranslate nohighlight">\(d^3x_c/dt^3\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(dz/dt\)</span> , <span class="math notranslate nohighlight">\(d^2z/dt^2\)</span>, <span class="math notranslate nohighlight">\(d^3z/dt^3\)</span></p></td>
</tr>
</tbody>
</table>
<p>Because the FMI API does not provide access to the required derivatives,
and FMI has limited support for QSS, we discuss extensions
that are needed for an efficient implementation of QSS.</p>
<section id="fmi-changes-for-qss">
<h3><span class="section-number">5.4.1. </span>FMI Changes for QSS<a class="headerlink" href="#fmi-changes-for-qss" title="Permalink to this headline">¶</a></h3>
<section id="setting-individual-elements-of-the-state-vector">
<h4><span class="section-number">5.4.1.1. </span>Setting individual elements of the state vector<a class="headerlink" href="#setting-individual-elements-of-the-state-vector" title="Permalink to this headline">¶</a></h4>
<p>QSS generally requires to only update a subset of the continuous-time state vector. We therefore
propose to use the function</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">fmi2Status</span><span class="w"> </span><span class="nf">fmi2SetReal</span><span class="p">(</span><span class="n">fmi2Component</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">fmi2ValueReference</span><span class="w"> </span><span class="n">vr</span><span class="p">[],</span><span class="w"></span>
<span class="w">                       </span><span class="kt">size_t</span><span class="w"> </span><span class="n">nx</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">fmi2Real</span><span class="w"> </span><span class="n">x</span><span class="p">[]);</span><span class="w"></span>
</pre></div>
</div>
<p>to set a subset of the continuous-time state vector.
This function exists in FMI-ME 2.0, but the standard only allows to call it for
continuous-time state variables during the initialization.</p>
<p>We therefore propose that the standard is being changed as follows:</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">fmi2SetReal</span></code> can be called during the continuous time mode
and during event mode not only for inputs,
as is allowed in FMI-ME 2.0, but also for continuous-time states.</p>
</div></blockquote>
<p>QSS performance considerations:</p>
<ul class="simple">
<li><p>QSS generally advances single variables at a time so atomic (single variable) get/set calls for all
variable quantity types (real, integer, boolean, …) would eliminate the loop overhead. The benefit
of atomic calls will vary by model type and size but without such calls we cannot assess the benefit and,
possibly, recommend this as an API extension for future FMI versions.
We therefore propose to add the following API to set continuous-time state variables,
discrete-time state variables and input variables:</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">fmi2Status</span><span class="w"> </span><span class="nf">fmi2Set1Real</span><span class="p">(</span><span class="n">fmi2Component</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="n">fmi2ValueReference</span><span class="w"> </span><span class="n">vr</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="n">fmi2Real</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Furthermore, if algebraic loops can be partitioned in such a way that a minimum
set of equations need to be updated during iterative solutions, this may further
reduce computing time for QSS.</p></li>
</ul>
</section>
<section id="getting-derivatives-of-state-variables">
<h4><span class="section-number">5.4.1.2. </span>Getting derivatives of state variables<a class="headerlink" href="#getting-derivatives-of-state-variables" title="Permalink to this headline">¶</a></h4>
<p>First order derivatives of state variables <span class="math notranslate nohighlight">\(\dot x_c(t)\)</span> in <a class="reference internal" href="#equation-eqn-ini-val">(5.1)</a>
can be obtained with the existing
<code class="docutils literal notranslate"><span class="pre">fmi2GetReal</span></code> function.</p>
<p>Second order derivatives of state variables <span class="math notranslate nohighlight">\(\ddot x_c(t)\)</span> can be obtained using directional
derivatives as</p>
<div class="math notranslate nohighlight">
\[\ddot x_c(t) = \frac{d^2 x_c(t)}{dt^2} = \frac{\partial \dot x_c(t)}{\partial x_c} \, \dot x_c(t).\]</div>
<p>QSS performance considerations:</p>
<ul class="simple">
<li><p>Using directional derivative calls that evaluate the whole derivative vector
for inherently atomic QSS derivative accesses is a
potentially large performance hit that may make the use of the directional derivatives call less
efficient than the (atomic) numerical differentiation that QSS has used. If atomic directional
derivatives (computing the necessary subset of the Jacobian) can be supported in the near term
that would make their use with QSS more practical.</p></li>
<li><p>Longer term, automatic differentiation with atomic 3rd derivatives of
state variables <span class="math notranslate nohighlight">\(\dddot x_c(t)\)</span> and zero-crossing variables
<span class="math notranslate nohighlight">\(\dddot z(x_c(t), x_d(t), t)\)</span> will be valuable for efficient QSS computations.</p></li>
<li><p>FMU generation should assure that calling <code class="docutils literal notranslate"><span class="pre">fmi2GetReal</span></code> on a time-derivative will not perform a
compute-all-derivatives operation internally.</p></li>
</ul>
<p>Proposed Future Requirements:</p>
<ul class="simple">
<li><p>Automatic differentiation engine to provide (atomic) higher derivative access.
This should include at least 2<sup>nd</sup> and 3<sup>rd</sup> derivatives of state variables
and 1<sup>st</sup>, 2<sup>nd</sup> and 3<sup>rd</sup> derivatives of event indicator variables.</p></li>
</ul>
</section>
<section id="event-handling">
<h4><span class="section-number">5.4.1.3. </span>Event Handling<a class="headerlink" href="#event-handling" title="Permalink to this headline">¶</a></h4>
<section id="state-events">
<span id="subsec-se"></span><h5><span class="section-number">5.4.1.3.1. </span>State Events<a class="headerlink" href="#state-events" title="Permalink to this headline">¶</a></h5>
<p>QSS needs additional dependency information beyond what is in the standard FMU <code class="docutils literal notranslate"><span class="pre">modelDescription.xml</span></code>
file to simulate state events correctly and efficiently. OCT provides this support with a vendor
annotation section, additional event indicator variables for the conditional clauses in <code class="docutils literal notranslate"><span class="pre">when</span></code>
and <code class="docutils literal notranslate"><span class="pre">if</span></code> constructs, and some changes to how dependencies are tracked.</p>
<p>For this discussion, consider the simple model</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">model</span> <span class="nc">DepTest</span>
  <span class="nb">Real</span> <span class="n">x</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// State</span>
  <span class="kr">discrete</span> <span class="nb">Real</span> <span class="n">l</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">fixed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">// Local</span>
  <span class="kr">discrete</span> <span class="kr">output</span> <span class="nb">Real</span> <span class="n">o</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">fixed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">);</span> <span class="c1">// Output</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">;</span>
<span class="kr">algorithm</span>
  <span class="kr">when</span> <span class="nb">time</span> <span class="o">&gt;</span> <span class="n">l</span> <span class="o">+</span> <span class="n">x</span> <span class="kr">then</span>
    <span class="n">l</span> <span class="o">:=</span> <span class="nb">pre</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">when</span> <span class="nb">time</span> <span class="o">&gt;</span> <span class="n">o</span> <span class="o">+</span> <span class="n">x</span> <span class="kr">then</span>
    <span class="n">o</span> <span class="o">:=</span> <span class="nb">pre</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
<span class="kr">annotation</span><span class="p">(</span> <span class="n">experiment</span><span class="p">(</span><span class="n">StartTime</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">StopTime</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">Tolerance</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span> <span class="p">);</span>
<span class="kr">end</span> <span class="nc">DepTest</span><span class="p">;</span>
</pre></div>
</div>
<p>For QSS the <code class="docutils literal notranslate"><span class="pre">modelDescription.xml</span></code> file should have an OCT vendor annotation of this form</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;VendorAnnotations&gt;</span>
  <span class="nt">&lt;Tool</span> <span class="na">name=</span><span class="s">&quot;Optimica Compiler Toolkit&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Annotations&gt;</span>
      <span class="nt">&lt;Annotation</span> <span class="na">name=</span><span class="s">&quot;CompilerVersion&quot;</span> <span class="na">value=</span><span class="s">&quot;OCT-r23206_JM-r14295&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/Annotations&gt;</span>
  <span class="nt">&lt;/Tool&gt;</span>
  <span class="nt">&lt;Tool</span> <span class="na">name=</span><span class="s">&quot;OCT_StateEvents&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;EventIndicators&gt;</span>
      <span class="nt">&lt;Element</span> <span class="na">index=</span><span class="s">&quot;11&quot;</span> <span class="na">reverseDependencies=</span><span class="s">&quot;46&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;Element</span> <span class="na">index=</span><span class="s">&quot;12&quot;</span> <span class="na">reverseDependencies=</span><span class="s">&quot;47&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/EventIndicators&gt;</span>
  <span class="nt">&lt;/Tool&gt;</span>
<span class="nt">&lt;/VendorAnnotations&gt;</span>
</pre></div>
</div>
<p>This vendor annotation describes that the first zero-crossing function <code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">-</span> <span class="pre">(</span> <span class="pre">l</span> <span class="pre">+</span> <span class="pre">x</span> <span class="pre">)</span> <span class="pre">&gt;</span> <span class="pre">0</span></code> (index 11)  modifies the
discrete local variable <code class="docutils literal notranslate"><span class="pre">l</span></code> (index 46), and that the second zero-crossing function
<code class="docutils literal notranslate"><span class="pre">time</span> <span class="pre">-</span> <span class="pre">(</span> <span class="pre">o</span> <span class="pre">+</span> <span class="pre">x</span> <span class="pre">)</span> <span class="pre">&gt;</span> <span class="pre">0</span></code> (index 12)  modifies the discrete output variable <code class="docutils literal notranslate"><span class="pre">o</span></code> (index 47).</p>
<p>This model demonstrates that QSS needs the full dependency information for local variables
that appear in event indicator expressions. That can be achieved by converting such variables
to output variables.</p>
<p>The dependency information to make this work is shown below</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;ModelStructure&gt;</span>
  <span class="nt">&lt;Outputs&gt;</span>
    <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;46&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;&quot;</span> <span class="na">dependenciesKind=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;47&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;&quot;</span> <span class="na">dependenciesKind=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;11&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;46 50 52&quot;</span> <span class="na">dependenciesKind=</span><span class="s">&quot;constant constant constant&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;12&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;47 50 52&quot;</span> <span class="na">dependenciesKind=</span><span class="s">&quot;constant constant constant&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/Outputs&gt;</span>
 <span class="nt">&lt;Derivatives&gt;</span>
   <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;53&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;&quot;</span> <span class="na">dependenciesKind=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
   <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;51&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;&quot;</span> <span class="na">dependenciesKind=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/Derivatives&gt;</span>
  <span class="nt">&lt;InitialUnknowns&gt;</span>
    <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;11&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;46 50 52&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;12&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;47 50 52&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;50&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;51&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;Unknown</span> <span class="na">index=</span><span class="s">&quot;53&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/InitialUnknowns&gt;</span>
<span class="nt">&lt;/ModelStructure&gt;</span>
</pre></div>
</div>
<p>where the indexes for the variables in this FMU built by OCT are</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 21%" />
<col style="width: 79%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Index</p></th>
<th class="head"><p>Variable</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>11</p></td>
<td><p>_eventIndicator_1</p></td>
</tr>
<tr class="row-odd"><td><p>12</p></td>
<td><p>_eventIndicator_2</p></td>
</tr>
<tr class="row-even"><td><p>46</p></td>
<td><p>l</p></td>
</tr>
<tr class="row-odd"><td><p>47</p></td>
<td><p>o</p></td>
</tr>
<tr class="row-even"><td><p>50</p></td>
<td><p>time</p></td>
</tr>
<tr class="row-odd"><td><p>51</p></td>
<td><p>der(time)</p></td>
</tr>
<tr class="row-even"><td><p>52</p></td>
<td><p>x</p></td>
</tr>
<tr class="row-odd"><td><p>53</p></td>
<td><p>der(x)</p></td>
</tr>
</tbody>
</table>
<p>The key differences in the dependencies for QSS are:</p>
<ul class="simple">
<li><p>State, local, and output variables modified by an
event indicator’s block when its state event occurs appear as its reverse dependencies and those
variables do <em>not</em> have dependencies on variables appearing in the event indicator.
State variables modified by a state event should themselves appear as a reverse dependency, not
their derivatives.</p></li>
<li><p>An event indicator has dependencies on all state, local, and output variables (other than those
with <code class="docutils literal notranslate"><span class="pre">variability=&quot;fixed&quot;</span></code>) appearing in its expression.</p></li>
<li><p>Local variables appearing in event indicator are converted to output variables to
give them a place for dependencies in the <code class="docutils literal notranslate"><span class="pre">&lt;Outputs&gt;</span></code> section of the <code class="docutils literal notranslate"><span class="pre">modelDescription.xml</span></code> file.
To indicate that these are extra outputs that are not declared as outputs in the Modelica model,
they are given the prefix <code class="docutils literal notranslate"><span class="pre">_qssLocal_</span></code>.</p></li>
</ul>
<p>QSS works with the FMU to process events. When a QSS zero-crossing event is at the top
of the QSS event queue, QSS sets the state of all dependencies of the corresponding
event indicator to their QSS trajectory values at a time slightly past the QSS-predicted
event time, and then runs the FMU event indicator process. The FMU should then detect the event
and run the event handler process that will update the value of the variables indicated
with the <code class="docutils literal notranslate"><span class="pre">reverseDependencies</span></code> attribute of the event indicator. QSS then performs the
necessary QSS-side updates to those reverse dependency variables and their dependent variables.
This time “bumping” is an indirect and potentially inefficient process, but without an “imperative”
API for telling the FMU that a state event occurred at a given time this procedure is necessary.</p>
<p>For efficiency, QSS requires knowledge of what variables an event indicator depends on,
and what variables the FMU will modify when an event fires.
Furthermore, QSS will need to have access to, or else approximate numerically, the time derivatives
of the event indicators. FMI 2.0 outputs an array of real-valued event indicators, but no variable
dependencies. Therefore, OPTIMICA adds event indicator output variables such as these for the
<code class="docutils literal notranslate"><span class="pre">DepTest</span></code> model above</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- Variable with index #11 --&gt;</span>
<span class="nt">&lt;ScalarVariable</span> <span class="na">name=</span><span class="s">&quot;_eventIndicator_1&quot;</span> <span class="na">valueReference=</span><span class="s">&quot;47&quot;</span> <span class="na">causality=</span><span class="s">&quot;output&quot;</span> <span class="na">variability=</span><span class="s">&quot;continuous&quot;</span> <span class="na">initial=</span><span class="s">&quot;calculated&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Real</span> <span class="na">relativeQuantity=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/ScalarVariable&gt;</span>
<span class="cm">&lt;!-- Variable with index #12 --&gt;</span>
<span class="nt">&lt;ScalarVariable</span> <span class="na">name=</span><span class="s">&quot;_eventIndicator_2&quot;</span> <span class="na">valueReference=</span><span class="s">&quot;48&quot;</span> <span class="na">causality=</span><span class="s">&quot;output&quot;</span> <span class="na">variability=</span><span class="s">&quot;continuous&quot;</span> <span class="na">initial=</span><span class="s">&quot;calculated&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Real</span> <span class="na">relativeQuantity=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/ScalarVariable&gt;</span>
</pre></div>
</div>
<p>This causes event indicators to become output variables, and therefore their dependency can be reported
using existing FMI 2.0 conventions.</p>
<p>Furthermore, OPTIMICA added in the <code class="docutils literal notranslate"><span class="pre">&lt;VendorAnnotations&gt;</span></code> the section <code class="docutils literal notranslate"><span class="pre">&lt;Tool</span> <span class="pre">name=&quot;OCT_StateEvents&quot;&gt;</span></code>.
The meaning of the entries in this section is as follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>The section <code class="docutils literal notranslate"><span class="pre">EventIndicators</span></code> lists all event indicators in an <code class="docutils literal notranslate"><span class="pre">&lt;Element&gt;</span></code> section.
Its entries are defined as follows:</p>
<ul>
<li><p>The attribute <code class="docutils literal notranslate"><span class="pre">index</span></code> points to the index of the event indicator, which OPTIMICA will add as an output
of the FMU.</p></li>
<li><p>The attribute <code class="docutils literal notranslate"><span class="pre">reverseDependencies</span></code> lists the index of the variables and state derivatives that
the FMU modifies <em>via</em> an event handler when it detects that this event has occurred.</p></li>
</ul>
</li>
</ul>
</div></blockquote>
<p>Note that event indicator (forward) <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> can be obtained from the section
<code class="docutils literal notranslate"><span class="pre">&lt;ModelStructure&gt;&lt;Outputs&gt;...&lt;/ModelStructure&gt;&lt;/Outputs&gt;</span></code> because OPTIMICA added the event indicators as
output variables.</p>
</section>
</section>
<section id="getting-derivatives-of-event-indicator-functions">
<h4><span class="section-number">5.4.1.4. </span>Getting derivatives of event indicator functions<a class="headerlink" href="#getting-derivatives-of-event-indicator-functions" title="Permalink to this headline">¶</a></h4>
<p>For some <span class="math notranslate nohighlight">\(n,m \in \mathbb N\)</span>, let <span class="math notranslate nohighlight">\(z \colon \Re^n \times \mathbb Z^m \times \Re \to \Re\)</span> be an event indicator function.
(For simplicity, we omitted the input and parameter dependency of <span class="math notranslate nohighlight">\(z(\cdot, \cdot, \cdot)\)</span> in <a class="reference internal" href="#equation-eqn-ini-val">(5.1)</a>.)
Then the first order time derivative of the event indicator <span class="math notranslate nohighlight">\(\dot z\)</span>
can be obtained using directional derivatives as</p>
<div class="math notranslate nohighlight" id="equation-eq-der-eve-ind">
<span class="eqno">(5.2)<a class="headerlink" href="#equation-eq-der-eve-ind" title="Permalink to this equation">¶</a></span>\[\dot z(x_c(t), x_d(t), t) = \frac{\partial z(x_c(t), x_d(t), t)}{\partial x_c} \, \dot x_c(t) + \frac{\partial z(x_c(t), x_d(t), t)}{\partial t}.\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To get <span class="math notranslate nohighlight">\(\frac{\partial z(x_c(t), x_d(t), t)}{\partial t}\)</span>, we need to add an output <span class="math notranslate nohighlight">\(\frac{\partial z(x_c(t), x_d(t), t)}{\partial t}\)</span>
unless it requires a derivative of an input. In this situation, the QSS solver will detect the missing
derivative information from the XML file and numerically approximate
the event indicator derivatives.</p>
</div>
<p>How to obtain second order derivatives of the event indicator functions <span class="math notranslate nohighlight">\(\ddot z(x_c(t), x_d(t), t)\)</span> is not yet specified.</p>
<p>QSS performance considerations:</p>
<ul class="simple">
<li><p>Without explicit derivative variables for continuous event indicator functions, the QSS zero-crossing variable
cannot accurately track the function of its dependent variables (for which we will have 1<sup>st</sup> and 2<sup>nd</sup> derivatives)
and thus will have lower accuracy for zero crossings.
The accuracy of zero crossings is vital not just for solution accuracy but because QSS must accurately predict crossings to
get robust FMU crossing event detection due to the indirect method QSS must use to try to get the FMU to detect crossings.
The need to numerically approximate derivatives is also a performance hit.
For these reasons it is strongly encouraged that explicit derivative variables be set up in the FMU for event indicators.
For 3<sup>rd</sup> order QSS, we would require atomic evaluation of
<span class="math notranslate nohighlight">\(\dot z(x_c(t), x_d(t), t)\)</span>, <span class="math notranslate nohighlight">\(\ddot z(x_c(t), x_d(t), t)\)</span> and <span class="math notranslate nohighlight">\(\dddot z(x_c(t), x_d(t), t)\)</span>.</p></li>
</ul>
</section>
<section id="test-models">
<h4><span class="section-number">5.4.1.5. </span>Test models<a class="headerlink" href="#test-models" title="Permalink to this headline">¶</a></h4>
<p>This section lists test cases that are corner cases for QSS.</p>
<section id="model-with-two-conditions-that-fire-an-event">
<h5><span class="section-number">5.4.1.5.1. </span>Model with two conditions that fire an event<a class="headerlink" href="#model-with-two-conditions-that-fire-an-event" title="Permalink to this headline">¶</a></h5>
<p>Consider the following model</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">StateEvent1</span> <span class="s2">&quot;This model tests state event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x1</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x2</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="kr">discrete</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealOutput</span> <span class="n">y</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span>
    <span class="s2">&quot;Ouput variable&quot;</span><span class="p">;</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
  <span class="kr">when</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="kr">then</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has 2 state events, one at t=0.25
and one at t=0.6924 when simulated from 0 to 1 s.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">StateEvent1</span><span class="p">;</span>
</pre></div>
</div>
<p>In this model, two conditions need to be satisfied
for an event to fire.</p>
</section>
<section id="event-indicators-that-depend-on-the-input">
<span id="subsec-te"></span><h5><span class="section-number">5.4.1.5.2. </span>Event indicators that depend on the input<a class="headerlink" href="#event-indicators-that-depend-on-the-input" title="Permalink to this headline">¶</a></h5>
<p>Consider the following model</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">StateEvent2</span> <span class="s2">&quot;This model tests state event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="kr">discrete</span> <span class="nb">Real</span> <span class="n">y</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span> <span class="s2">&quot;Discrete variable&quot;</span><span class="p">);</span>
  <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealInput</span> <span class="n">u</span> <span class="s2">&quot;Input variable&quot;</span>
    <span class="kr">annotation</span> <span class="p">(</span><span class="n">Placement</span><span class="p">(</span><span class="n">transformation</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">140</span><span class="p">,</span><span class="o">-</span><span class="mi">20</span><span class="p">},{</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="mi">20</span><span class="p">}})));</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
  <span class="kr">when</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="kr">then</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has a state event
when u becomes bigger than x.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">StateEvent2</span><span class="p">;</span>
</pre></div>
</div>
<p>This model has one event indicator <span class="math notranslate nohighlight">\(z = u-x\)</span>.
The derivative of the event indicator is <span class="math notranslate nohighlight">\({dz}/{dt} = {du}/{dt} - {dx}/{dt}\)</span>.</p>
<p>Hence, a tool requires the derivative of the input <code class="docutils literal notranslate"><span class="pre">u</span></code>
to compute the derivative of the event indicator.
Since the derivative of the input <code class="docutils literal notranslate"><span class="pre">u</span></code> is unkown in the FMU,
we propose for cases where the event indicator
has a direct feedthrough on the input to not add time derivatives of
event indicators as outputs.
In this situation, the QSS solver will detect the missing
information from the XML file and numerically approximate
the event indicator derivatives.</p>
</section>
<section id="handling-of-variables-reinitialized-with-reinit">
<h5><span class="section-number">5.4.1.5.3. </span>Handling of variables reinitialized with <code class="docutils literal notranslate"><span class="pre">reinit()</span></code><a class="headerlink" href="#handling-of-variables-reinitialized-with-reinit" title="Permalink to this headline">¶</a></h5>
<p>Consider following model</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">StateEvent3</span> <span class="s2">&quot;This model tests state event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x1</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x2</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">=</span> <span class="n">x1</span><span class="p">;</span>
<span class="kr">when</span> <span class="nb">time</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="kr">then</span>
  <span class="nb">reinit</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has 1 state event at t=0.5s
when simulated from 0 to 1s.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">StateEvent3</span><span class="p">;</span>
</pre></div>
</div>
<p>This model has a variable <code class="docutils literal notranslate"><span class="pre">x1</span></code> which
is reinitialized with the <code class="docutils literal notranslate"><span class="pre">reinit()</span></code> function.
Such variables have in the model description file
an attribute <code class="docutils literal notranslate"><span class="pre">reinit</span></code> which can be set to
<code class="docutils literal notranslate"><span class="pre">true</span></code> or <code class="docutils literal notranslate"><span class="pre">false</span></code> depending on whether they can
be reinitialized at an event or not.
Since  a <code class="docutils literal notranslate"><span class="pre">reinit()</span></code> statement is only valid
in a <code class="docutils literal notranslate"><span class="pre">when-equation</span></code> block, we propose for
variables with <code class="docutils literal notranslate"><span class="pre">reinit</span></code> set to true,
that at every state event, the QSS solver gets the value of
the variable, updates variables which depend on it, and proceeds
with its calculation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Per design, Dymola (2018) generates twice as many event indicators as actually existing in the model.
Hence the master algorithm shall detect if the tool which exported the FMU is Dymola, and if it is, the
number of event indicators shall be equal to half the value of the <code class="docutils literal notranslate"><span class="pre">numberOfEventIndicators</span></code> attribute.</p>
</div>
</section>
<section id="time-events">
<h5><span class="section-number">5.4.1.5.4. </span>Time Events<a class="headerlink" href="#time-events" title="Permalink to this headline">¶</a></h5>
<p>This section discusses additional requirements for handling time events with QSS.</p>
<p>Consider following model</p>
<div class="highlight-modelica notranslate"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">TimeEvent</span> <span class="s2">&quot;This model tests time event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x1</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x2</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="kr">discrete</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealOutput</span> <span class="n">y</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span>
    <span class="s2">&quot;Output variable&quot;</span><span class="p">;</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x2</span><span class="p">;</span>
  <span class="kr">when</span> <span class="p">(</span><span class="nb">time</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="kr">then</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has 1 time event at t=0.5s
when simulated from 0 to 1s.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">TimeEvent</span><span class="p">;</span>
</pre></div>
</div>
<p>This model has a time event at <span class="math notranslate nohighlight">\(t \ge 0.5\)</span>.
For efficiency, QSS requires the FMU which exports
this model to indicate in its model description file
the dependency of <code class="docutils literal notranslate"><span class="pre">der(x1)</span></code> on <code class="docutils literal notranslate"><span class="pre">y</span></code>.
However, since <code class="docutils literal notranslate"><span class="pre">y</span></code> updates when a time event happens
but a time event is not described with event indicator,
it is not possible to use the same approach as done for
<code class="docutils literal notranslate"><span class="pre">StateEvent1</span></code> without further modificaton.</p>
<p>We therefore propose that OPTIMICA turns all time events into state events and
adds new event indicators as output variables.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All proposed XML changes will be initially implemented
in the <code class="docutils literal notranslate"><span class="pre">VendorAnnotation</span></code> element of the model description file until
they got approved and included in the FMI standard.</p>
</div>
</section>
</section>
<section id="smoothtoken-for-qss">
<h4><span class="section-number">5.4.1.6. </span>SmoothToken for QSS<a class="headerlink" href="#smoothtoken-for-qss" title="Permalink to this headline">¶</a></h4>
<p>This section discusses a proposal for a new data type which should be used for input and output variables of FMU-QSS.
FMU-QSS is an FMU for Model Exchange (FMU-ME) which uses QSS to integrate an imported FMU-ME.
We propose that FMU-QSS communicates with other FMUs using a SmoothToken data type.</p>
<p>A smooth token is a time-stamped event that has a real value (approximated as a <code class="docutils literal notranslate"><span class="pre">double</span></code>)
that represents the current sample of a real-valued smooth signal. But in addition to the sample value,
the smooth token contains zero or more time-derivatives of the signal at the stored time stamp.
For example, in the figure below, FMU-ME has a real input <span class="math notranslate nohighlight">\(u\)</span> and a real output <span class="math notranslate nohighlight">\(y\)</span>.
A smooth token of the input variable will be a variable <span class="math notranslate nohighlight">\(u^* \triangleq [u, n, du/dt, ...,  d^n u/dt^n, t_u]\)</span>,
where <span class="math notranslate nohighlight">\(n \in \{0, 1, 2, \ldots \}\)</span> is a parameter that defines the number of time derivatives that are present in the smooth token and
<span class="math notranslate nohighlight">\(t_u\)</span> is the timestamp of the smooth token.
If <span class="math notranslate nohighlight">\(u^*\)</span> has a discontinuity at <span class="math notranslate nohighlight">\(t_u\)</span>,
then the derivatives are the derivatives from above, e.g., <span class="math notranslate nohighlight">\(du/dt \triangleq \lim_{s \downarrow 0} (u(t_u+s)-u(t_u))/s\)</span>.</p>
<p>At simulation time <span class="math notranslate nohighlight">\(t\)</span>, FMU-QSS will receive <span class="math notranslate nohighlight">\(u^*\)</span> and convert it to a real signal
using the Taylor expansion</p>
<div class="math notranslate nohighlight">
\[y_s(t) = \frac{u^{(n)}(t_u)}{n!} \, (t-t_u)^n,\]</div>
<p>where <span class="math notranslate nohighlight">\(u^{(n)}\)</span> denotes the <span class="math notranslate nohighlight">\(n\)</span>-th derivative. As shown in <a class="reference internal" href="#fig-fmu-qss"><span class="std std-numref">Fig. 5.5</span></a>, the FMU-ME will receive
the value <span class="math notranslate nohighlight">\(y_s(t)\)</span>.</p>
<figure class="align-default" id="id10">
<span id="fig-fmu-qss"></span><a class="reference internal image-reference" href="_images/fmu-qss.png"><img alt="_images/fmu-qss.png" src="_images/fmu-qss.png" style="width: 1069.2px; height: 392.15000000000003px;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 5.5 </span>: Conversion of input signal between FMU-QSS and FMU-ME.</span><a class="headerlink" href="#id10" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>To avoid frequent changes in the input signal, each input signal will have a quantum defined.
The quantum <span class="math notranslate nohighlight">\(\delta q\)</span> will be computed at runtime as</p>
<div class="math notranslate nohighlight">
\[\delta q = \max(\epsilon_{rel} \, |u^-|, \epsilon_{abs}),\]</div>
<p>where <span class="math notranslate nohighlight">\(\epsilon_{rel}\)</span> is the relative tolerance,
<span class="math notranslate nohighlight">\(u^-\)</span> is the last value seen at the input of FMU-ME, and
<span class="math notranslate nohighlight">\(\epsilon_{abs} \triangleq \epsilon_{rel} \, |u_{nom}|\)</span>,
where <span class="math notranslate nohighlight">\(u_{nom}\)</span> is the nominal value of the variable <span class="math notranslate nohighlight">\(u\)</span>.
During initialization, we set <span class="math notranslate nohighlight">\(u^- = u_0\)</span>.
The input signal will be updated only if it has changed by more than a quantum,</p>
<div class="math notranslate nohighlight">
\[|y_s(t) - u^-| \ge \delta q.\]</div>
<p>To parametrize the smooth token, we propose to extend the FMI for model exchange specification to include
<code class="docutils literal notranslate"><span class="pre">fmi2SetRealInputDerivatives</span></code> and <code class="docutils literal notranslate"><span class="pre">fmi2GetRealOutputDerivatives</span></code>. These two functions exist in the FMI for
co-simulation API.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li><p>If a tool can not provide the derivative of an output variable with respect to time,
<code class="docutils literal notranslate"><span class="pre">fmi2GetRealOutputDerivatives</span></code> then a master algorithm could approximate
the output derivative as follows:</p>
<ul>
<li><p>If there was no event, then the time derivatives from below and above are equal, and
hence past and current output values can be used, e.g.,</p>
<div class="math notranslate nohighlight">
\[dy/dt \approx \frac{y(t_k)-y(t_{k-1})}{t_k - t_{k-1}}.\]</div>
</li>
<li><p>If there was an event, then the derivative from above need to be approximated.
This could be done by assuming first <span class="math notranslate nohighlight">\(dy/dt =0\)</span> and then building up derivative
information in the next step, or by evaluating the FMU for <span class="math notranslate nohighlight">\(t=t_k+\epsilon\)</span>, where
<span class="math notranslate nohighlight">\(\epsilon\)</span> is a small number, and then computing</p>
<div class="math notranslate nohighlight">
\[dy/dt \approx \frac{y(t_k+\epsilon)-y(t_{k})}{\epsilon}.\]</div>
</li>
</ul>
</li>
<li><p>For FMU-ME, if there is a direct feedthrough, e.g., <span class="math notranslate nohighlight">\(y=f(u)\)</span>,
then <span class="math notranslate nohighlight">\(dy/dt\)</span> cannot be computed, because by the chain rule,</p>
<div class="math notranslate nohighlight">
\[\frac{df(u)}{dt} = \frac{df(u)}{du} \, \frac{du}{dt}\]</div>
<p>but <span class="math notranslate nohighlight">\(du/dt\)</span> is not available in the FMU.</p>
</li>
</ul>
</div>
</section>
<section id="summary-of-proposed-changes">
<h4><span class="section-number">5.4.1.7. </span>Summary of Proposed Changes<a class="headerlink" href="#summary-of-proposed-changes" title="Permalink to this headline">¶</a></h4>
<p><strong>To be updated</strong></p>
<p>Here is a list with a summary of proposed changes</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">fmi2SetReal</span></code> can be called during the continuous, and event time mode for continuous-time states.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">&lt;Derivatives&gt;</span></code> element of the model description file will
be extended to include higher order derivatives information.</p></li>
<li><p>A new <code class="docutils literal notranslate"><span class="pre">&lt;EventIndicators&gt;</span></code> element wil be added to the model description file.
This element will expose event indicators with their <code class="docutils literal notranslate"><span class="pre">dependencies</span></code> and time derivatives.</p></li>
<li><p>If a model has an event indicator, and the event indicator has a direct
feedthrough on an input variable, then OPTIMICA will exclude the derivatives
of that event indicator from the model description file.</p></li>
<li><p>A new dependency attribute <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code> will be added to state derivatives listed
in the <code class="docutils literal notranslate"><span class="pre">&lt;Derivatives&gt;</span></code> element to include event indicators on which the state derivatives depend on.</p></li>
<li><p>OPTIMICA will convert time event into state events, generate event indicators
for those state events, and add those event indicators to the <code class="docutils literal notranslate"><span class="pre">eventIndicatorsDependencies</span></code>
of state derivatives which depend on them.</p></li>
<li><p>A new function <code class="docutils literal notranslate"><span class="pre">fmi2SetRealInputDerivatives</span></code> will be included to parametrize smooth token.</p></li>
<li><p>A new function <code class="docutils literal notranslate"><span class="pre">fmi2GetRealOutputDerivatives</span></code> will be included to parametrize smooth token.</p></li>
<li><p>All proposed XML changes will be initially implemented in the <code class="docutils literal notranslate"><span class="pre">VendorAnnotation</span></code>
element of the model description file until they got approved and included in the FMI standard.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>We need to determine when to efficiently call <code class="docutils literal notranslate"><span class="pre">fmi2CompletedIntegratorStep()</span></code> to signalize that
an integrator step is complete.</p></li>
<li><p>We need to determine how an FMU deals with state selection, detect it, and reject it
on the QSS side.</p></li>
</ul>
</div>
</section>
<section id="open-topics">
<h4><span class="section-number">5.4.1.8. </span>Open Topics<a class="headerlink" href="#open-topics" title="Permalink to this headline">¶</a></h4>
<p>This section includes a list of measures which could further improve the efficiency of QSS.
Some of the measures should be implemented and benchmarked to ensure their necessity for QSS.</p>
<section id="atomic-api">
<h5><span class="section-number">5.4.1.8.1. </span>Atomic API<a class="headerlink" href="#atomic-api" title="Permalink to this headline">¶</a></h5>
<p>A fundamental property of QSS is that variables are advanced at different time rates.
To make this practically efficient with FMUs, an API for individual values and derivatives is essential.</p>
</section>
<section id="xml-api">
<h5><span class="section-number">5.4.1.8.2. </span>XML/API<a class="headerlink" href="#xml-api" title="Permalink to this headline">¶</a></h5>
<p>All variables with non-constant values probably need to be exposed via the xml
with all their interdependencies. The practicality and benefit of trying
to hide some variables such as algebraic variables by short-circuiting
their dependencies in the xml (or doing this short-circuiting on the QSS side)
should be considered for efficiency reasons.</p>
</section>
<section id="higher-derivatives">
<h5><span class="section-number">5.4.1.8.3. </span>Higher Derivatives<a class="headerlink" href="#higher-derivatives" title="Permalink to this headline">¶</a></h5>
<p>Numerical differentiation significantly complicates and slows the QSS code:
automatic differentiation provided by the FMU will be a major improvement
and allows practical development of 3rd order QSS solvers.</p>
</section>
<section id="input-variables">
<h5><span class="section-number">5.4.1.8.4. </span>Input Variables<a class="headerlink" href="#input-variables" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p>Input functions with discontinuities up to the QSS order need to be exposed to
QSS and provide next event time access to the master algorithm.</p></li>
<li><p>Input functions need to be true (non-path-dependent) functions for
QSS use or at least provide a way to evaluate without “memory”
to allow numeric differentiation and event trigger stepping.</p></li>
</ul>
</section>
<section id="annotations">
<h5><span class="section-number">5.4.1.8.5. </span>Annotations<a class="headerlink" href="#annotations" title="Permalink to this headline">¶</a></h5>
<p>Some per-variable annotations that will allow for more efficient solutions by overriding global settings (which are also needed as annotations) include:</p>
<ul class="simple">
<li><p>Various time steps: <code class="docutils literal notranslate"><span class="pre">dt_min</span></code>, <code class="docutils literal notranslate"><span class="pre">dt_max</span></code>, <code class="docutils literal notranslate"><span class="pre">dt_inf</span></code>, …</p></li>
<li><p>Various flags: QSS method/order (or traditional ODE method for mixed solutions), inflection point requantization, …</p></li>
<li><p>Extra variability flags: constant, linear, quadratic, cubic, variable, …</p></li>
</ul>
</section>
<section id="conditional-expressions-and-event-indicators">
<h5><span class="section-number">5.4.1.8.6. </span>Conditional Expressions and Event Indicators<a class="headerlink" href="#conditional-expressions-and-event-indicators" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p>How to reliably get the FMU to detect an event at the time QSS predicts one?</p>
<p>QSS predicts zero-crossing event times that, even with Newton refinement,
may be slightly off. To get the FMU to “detect” these events with its
“after the fact” event indicators the QSS currently bumps the time forward
by some epsilon past the predicted event time in the hopes that the FMU will detect it.
Even if made smarter about how big a step to take this will never be robust.
Missing events can invalidate simulations. If there is no good and efficient FMU API
solution we may need to add the capability for the QSS to handle “after the fact” detected
events but with the potential for large QSS time steps and without rollback
capability this would give degraded results at best.</p>
</li>
<li><p>How much conditional structure should we expose to QSS?</p>
<p>Without full conditional structure information the QSS must fire events
that aren’t relevant in the model/FMU. This will be inefficient
for models with many/complex conditionals. These non-event events also
alter the QSS trajectories so, for example, adding a conditional
clause that never actually fires will change the solution somewhat, which is non-ideal.</p>
</li>
<li><p>QSS needs a mechanism similar to zero crossing functions to deal with Modelica’s event generating functions (such as
<code class="docutils literal notranslate"><span class="pre">div(x,y)</span></code> See <a class="reference external" href="http://book.xogeny.com/behavior/discrete/events/#event-generating-functions">http://book.xogeny.com/behavior/discrete/events/#event-generating-functions</a>) to avoid missing solution discontinuities.</p></li>
<li><p>Discrete and non-smooth internal variables need to be converted to input variables or exposed (with dependencies) to QSS.</p></li>
<li><p>QSS need dependency information for algebraic and boolean/discrete variables
either explicitly or short-circuited through the exposed variables for those the QSS won’t track.</p></li>
<li><p>The xml needs to expose the structure of each conditional block:
if or when, sequence order of if/when/else conditionals,
and all the (continuous and discrete/boolean) variables appearing in each conditional.</p></li>
<li><p>Non-input boolean/discrete/integer variables should ideally be altered
only by event indicator handlers or <em>time events</em> that are exposed by the FMU
(during loop or by direct query?). Are there other ways that
such variables can change that are only detectable after the fact?
If so, this leaves the QSS with the bad choices of late detection
(due to large time steps) or forcing regular time step value checks on them.</p></li>
<li><p>QSS needs the dependencies of conditional expressions on variables appearing in them.</p></li>
<li><p>QSS needs the dependencies of variables altered when each conditional fires on the conditional expression variables.</p></li>
<li><p>It is not robust for the QSS to try and guess a time point where the FMU will
reliably detect a zero crossing so we need an API to tell the
FMU that a zero crossing occurred at a given time (and maybe with crossing direction information).</p></li>
<li><p>If the xml can expose the zero crossing directions of interest that will allow for more efficiency.</p></li>
</ul>
</section>
</section>
</section>
</section>
<section id="integration-with-openstudio">
<span id="sec-int-ope-stu"></span><h2><span class="section-number">5.5. </span>Integration with OpenStudio<a class="headerlink" href="#integration-with-openstudio" title="Permalink to this headline">¶</a></h2>
<p>The integration with OpenStudio will be done through
an html5 widget. The development of this link is documented at
<a class="reference external" href="https://github.com/lbl-srg/linkage.js">https://github.com/lbl-srg/linkage.js</a></p>
</section>
</section>


    </div>
      
  </div>
</div>
  
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright (c) All rights reserved.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.3.2.<br/>
    </p>
  </div>
</footer>

  </body>
</html>